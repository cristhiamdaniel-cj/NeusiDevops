{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ğŸ“Š Enlaces Daily â†” (Tareas/Subtareas)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background: linear-gradient(180deg,#ede3ff 0%,#f9f7ff 100%); font-family: 'Segoe UI',system-ui,sans-serif; }
    .card{ border:none; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .chip{ display:inline-block; background:#efeaff; color:#3d2fb0; padding:.15rem .55rem; border-radius:999px; font-weight:700; font-size:.8rem; }
    .muted{ color:#6c757d; }
    .btn-neusi{ background:#6B4EFF; color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-neusi:hover{ background:#5b40e0; }
    .btn-coral{ background:#FF6B6B; color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-coral:hover{ background:#ff5252; }
    .table thead th{ background:#f4f0ff; color:#3d2fb0; border-bottom:0; }
    .sticky-head{ position:sticky; top:0; background:#fff; z-index:5; padding:.5rem 0; }
    .small-muted{ font-size:.9rem; color:#6c757d; }
    .pill{ display:inline-block; border-radius:999px; background:#f1edff; color:#3d2fb0; padding:.25rem .6rem; font-weight:600; }
    .desc-box{ background:#f7f7ff; border:1px solid #ecebff; border-radius:10px; padding:.4rem .6rem; }
  </style>
</head>
<body class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 sticky-head">
    <h2 class="fw-bold">ğŸ“Š Enlaces Daily â†” (Tareas/Subtareas)</h2>
    <div>
      <a href="{% url 'daily_resumen' %}" class="btn btn-neusi me-2">â† Resumen</a>
      <a href="{% url 'home' %}" class="btn btn-coral">ğŸ  Home</a>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Desde</label>
          <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Hasta</label>
          <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Integrante</label>
          <select name="integrante" class="form-select">
            <option value="">â€” Todos â€”</option>
            {% for i in integrantes %}
              <option value="{{ i.id }}" {% if sel_integrante == i.id|stringformat:"s" %}selected{% endif %}>
                {{ i.user.first_name }} {{ i.user.last_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-2 form-check ms-2">
          <input class="form-check-input" type="checkbox" name="include_closed" id="incl" value="1" {% if include_closed %}checked{% endif %}>
          <label class="form-check-label" for="incl">Incluir cerradas</label>
        </div>
        <div class="col-12 col-md-12">
          <button class="btn btn-neusi">Aplicar filtros</button>
        </div>
      </form>
      <p class="small-muted mb-0 mt-2">
        Muestra cada Tarea/Subtarea enlazada en dailies del rango. La columna
        <em>DescripciÃ³n</em> usa el texto del DailyItem y, si estaba vacÃ­o, toma â€œQuÃ© harÃ¡s hoyâ€ del Daily.
      </p>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th style="width:110px;">Tipo</th>
            <th>Tarea / Subtarea</th>
            <th style="width:160px;">Estado</th>
            <th style="width:200px;">Responsable</th>
            <th style="width:220px;">Sprint/Bloque</th>
            <th style="width:320px;">DescripciÃ³n (QuÃ© harÃ¡s hoy)</th>
            <th>Enlazado en Dailies</th>
          </tr>
        </thead>
        <tbody>
        {% for r in resultados %}
          <tr>
            <td><span class="chip">{{ r.tipo }}</span></td>

            <td>
              {% if r.tipo == "SUBTAREA" %}
                <div class="fw-semibold">{{ r.subtarea_titulo|default:"â€”" }}</div>
                <div class="small-muted">Tarea: {{ r.tarea_titulo|default:"â€”" }}</div>
              {% else %}
                <div class="fw-semibold">{{ r.tarea_titulo|default:"â€”" }}</div>
              {% endif %}
            </td>

            <td>
              {% if r.tipo == "SUBTAREA" %}
                {{ r.subtarea_estado|default:"â€”" }}
              {% else %}
                {{ r.tarea_estado|default:"â€”" }}
              {% endif %}
            </td>

            <td>{{ r.asignado|default:"â€”" }}</td>

            <td>
              {% if r.tipo == "SUBTAREA" %}
                {{ r.subtarea_bloque|default:"â€”" }}
              {% else %}
                {{ r.tarea_sprint|default:"â€”" }}
              {% endif %}
            </td>

            <td>
              {% if r.enlaces %}
                {% for e in r.enlaces %}
                  <div class="desc-box mb-2">
                    <div class="small-muted mb-1"><span class="pill">{{ e.fecha }}</span> Â· {{ e.integrante }}</div>
                    <div>{{ e.descripcion|default:"â€”"|truncatechars:180 }}</div>
                  </div>
                {% endfor %}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>

            <td style="min-width:200px;">
              {% if r.enlaces %}
                {% for e in r.enlaces %}
                  <span class="chip me-1 mb-1">{{ e.fecha }} Â· {{ e.integrante }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">â€”</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">Sin datos que cumplan los filtros.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
