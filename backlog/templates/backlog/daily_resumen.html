{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>ğŸ“ Resumen de Dailies - NEUSI Task Manager</title>
    <link rel="stylesheet" href="{% static 'backlog/daily-resumen.css' %}?v=4">
</head>
<body>

<!-- Encabezado -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ“ Resumen de Dailies</h2>
    {% if request.user.is_authenticated %}
    <div style="text-align: right;">
        <a href="{% url 'home' %}" class="btn btn-secondary">ğŸ  Home</a>
        <span style="margin: 0 15px;">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-danger">ğŸšª Cerrar SesiÃ³n</a>
    </div>
    {% endif %}
</div>

<!-- Accesos rÃ¡pidos -->
<div style="margin-bottom: 15px;">
    <form method="get" action="{% url 'daily_personal' %}" style="display:inline;">
        <button type="submit" class="btn btn-success">ğŸ“… Mi Daily Personal</button>
    </form>

    {% if tiene_permisos_admin %}
        <a href="{% url 'daily_create_admin' %}" class="btn btn-primary">â• Crear Daily</a>
    {% endif %}
</div>

<!-- ğŸ” Filtros (Admin o Visualizador) -->
{% if puede_filtrar %}
<div class="card">
    <h4>ğŸ” Filtros:</h4>
    <form method="get" style="display: inline-flex; align-items: center; gap: 15px;">
        <label for="persona">Ver dailies de:</label>
        <select name="persona" id="persona" onchange="this.form.submit()">
            <option value="">-- Todas las personas --</option>
            {% for i in integrantes %}
                <option value="{{ i.id }}" {% if persona_id == i.id|stringformat:"s" %}selected{% endif %}>
                    {{ i.user.first_name }} {{ i.user.last_name }}
                </option>
            {% endfor %}
        </select>
        {% if persona_id %}
            <a href="{% url 'daily_resumen' %}" class="btn btn-danger btn-sm">âŒ Limpiar</a>
        {% endif %}
    </form>
    <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
        {% if tiene_permisos_admin %}
            ğŸ’¡ Como administrador, puedes ver y filtrar los dailies de todo el equipo.
        {% else %}
            ğŸ‘€ Como visualizador, puedes ver y filtrar los dailies de todo el equipo (solo lectura).
        {% endif %}
    </div>
</div>
{% else %}
<div class="card" style="background: #fff3cd; border: 1px solid #ffeaa7;">
    <h4 style="color: #856404;">ğŸ“‹ Vista Personal</h4>
    <p style="color: #856404; margin: 0;">
        Solo puedes ver tu propio historial de dailies.
        Para acceder a los dailies del equipo completo, contacta a Daniel Campos o AndrÃ©s GÃ³mez.
    </p>
</div>
{% endif %}

<!-- Accesos a Backlog -->
<div style="margin-bottom: 15px;">
    <a href="{% url 'backlog_lista' %}" class="btn btn-success">ğŸ“‹ Ver Backlog</a>
    <a href="{% url 'backlog_matriz' %}" class="btn btn-info">ğŸ“Š Ver Matriz</a>
</div>

<!-- Tabla de Dailies -->
<table>
    <tr>
        <th>ğŸ‘¤ Integrante</th>
        <th>ğŸ“… Fecha</th>
        <th>âœ… Ayer</th>
        <th>ğŸ¯ Hoy</th>
        <th>â›” Impedimentos</th>
        <th>â° Estado</th>
        {% if tiene_permisos_admin %}
        <th>âš™ Acciones</th>
        {% endif %}
    </tr>
    {% for d in registros %}
    <tr class="{% if d.fuera_horario %}fuera-horario{% endif %}">
        <td><strong>{{ d.integrante.user.first_name }}</strong></td>
        <td><strong>{{ d.fecha }}</td></strong>
        <td><strong>{{ d.que_hizo_ayer }}</td></strong>
        <td><strong>{{ d.que_hara_hoy }}</td></strong>
        <td><strong>{{ d.impedimentos|default:"-" }}</td></strong>
        <td>
            {% if d.fuera_horario %}
                <span class="estado-fuera">âš  Fuera de horario</span>
            {% else %}
                <span class="estado-ok">âœ… En horario</span>
            {% endif %}
        </td>
        {% if tiene_permisos_admin %}
        
            <form method="post" action="{% url 'eliminar_daily' d.id %}" style="display:inline;">
                {% csrf_token %}
                <td>
                    <a href="{% url 'eliminar_daily' d.id %}" class="btn btn-danger btn-sm">ğŸ—‘ Eliminar</a>
                </td>
                
            </form>
        
        {% endif %}
    </tr>
    {% empty %}
    <tr>
        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
            No hay registros de daily.
        </td>
    </tr>
    {% endfor %}
</table>

<!-- JS de refuerzo -->
<script>
(function(){
  var b = document.getElementById('btn-daily-personal');
  if(!b) return;
  b.addEventListener('click', function(e){
    e.preventDefault();
    var href = this.getAttribute('href');
    if (!href) return;
    window.location.assign(href);
  });
})();
</script>

</body>
</html>
