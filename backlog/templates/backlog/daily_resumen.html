{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen de Dailies - NEUSI Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Fondo NEUSI (conservado) */
    body{
      background: linear-gradient(180deg, #ede3ff 0%, #f9f7ff 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
    }

    /* Paleta (colores del logo) */
    :root{
      --neusi-purple: #5B3985;          /* principal */
      --neusi-purple-2: #6B4EFF;        /* acento */
      --neusi-coral:  #FF6B6B;          /* alerta */
      --neusi-green:  #00C48C;          /* ok */
      --neusi-blue:   #4BA3FF;          /* info secundaria */
    }

    /* Botones */
    .btn-neusi      { background: var(--neusi-purple); color:#fff !important; border:none; border-radius:10px; font-weight:600; }
    .btn-neusi:hover{ background: #4a2f6d; }
    .btn-coral      { background: var(--neusi-coral); color:#fff !important; border:none; border-radius:10px; font-weight:600; }
    .btn-coral:hover{ background: #ff5252; }
    .btn-green      { background: var(--neusi-green); color:#fff !important; border:none; border-radius:10px; font-weight:600; }
    .btn-green:hover{ background: #00a97b; }
    .btn-blue       { background: var(--neusi-blue); color:#fff !important; border:none; border-radius:10px; font-weight:600; }
    .btn-blue:hover { background: #318ff0; }

    /* Tarjetas / tabla */
    .card{ border:none; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .table thead th{ background:#f4f0ff; color:#3d2fb0; border-bottom:0; }
    .table tbody tr.table-soft-warning{ background:#fff6f6; } /* fila fuera de horario */

    /* Chips / badges */
    .chip-ok   { background:#e7fbf5; color:var(--neusi-green); border:1px solid #b6f0de; padding:.15rem .5rem; border-radius:999px; font-weight:600; }
    .chip-warn { background:#ffecec; color:var(--neusi-coral); border:1px solid #ffc9c9; padding:.15rem .5rem; border-radius:999px; font-weight:600; }

    .mini-metric{ font-size:.85rem; color:#6c757d; margin-top:.25rem; }
    .metric-badge{
      display:inline-block; min-width:44px; text-align:center;
      background:#efeaff; color:#3d2fb0; border-radius:999px; padding:.15rem .5rem; font-weight:700;
    }

    .page-title { color:#3d2fb0; font-weight:700; }
  </style>
</head>

<body class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-title m-0">Resumen de Dailies</h2>
    {% if request.user.is_authenticated %}
      <div class="text-end">
        <a href="{% url 'home' %}" class="btn btn-neusi me-2">Home</a>
        <span class="fw-semibold me-2">{{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-coral">Cerrar sesión</a>
      </div>
    {% endif %}
  </div>

  <!-- Accesos rápidos -->
  <div class="mb-3">
    <a href="{% url 'daily_personal' %}" class="btn btn-green me-2">Mi Daily personal</a>
    {% if tiene_permisos_admin %}
      <a href="{% url 'daily_create_admin' %}" class="btn btn-coral">Crear Daily</a>
    {% endif %}
    {% if tiene_permisos_admin %}
  <a href="{% url 'reporte_enlaces_daily' %}" class="btn btn-neusi ms-2"> Enlaces Daily</a>
{% endif %}

  </div>

  <!-- Filtros -->
  {% if puede_filtrar %}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="text-uppercase text-muted mb-3">Filtros</h6>
      <form method="get" class="d-flex align-items-center gap-2 flex-wrap">
        <label for="persona" class="me-1">Ver dailies de</label>
        <select name="persona" id="persona" class="form-select" style="max-width:260px" onchange="this.form.submit()">
          <option value="">— Todos —</option>
          {% for i in integrantes %}
            <option value="{{ i.id }}" {% if persona_id == i.id|stringformat:"s" %}selected{% endif %}>
              {{ i.user.first_name }} {{ i.user.last_name }}
            </option>
          {% endfor %}
        </select>
        {% if persona_id %}
          <a href="{% url 'daily_resumen' %}" class="btn btn-coral btn-sm">Limpiar</a>
        {% endif %}
      </form>
      <p class="text-muted small mb-0 mt-2">
        {% if tiene_permisos_admin %}Como administrador puedes ver y filtrar los dailies de todo el equipo.{% else %}Como visualizador puedes consultar los dailies del equipo (solo lectura).{% endif %}
      </p>
    </div>
  </div>
  {% else %}
  <div class="card bg-warning-subtle mb-4">
    <div class="card-body">
      <h6 class="text-uppercase text-warning-emphasis mb-2">Vista personal</h6>
      <p class="text-secondary mb-0">Solo puedes ver tu propio historial de dailies.</p>
    </div>
  </div>
  {% endif %}

  <!-- Nota de Alineación -->
  <div class="alert alert-info mb-3" role="alert">
    <strong>Alineación %</strong> muestra qué tan relacionadas están tus actividades del Daily con tus tareas asignadas.
    Mientras más alto, más conectado está tu reporte diario con el trabajo planificado.
  </div>

  <!-- Accesos Backlog / Matriz -->
  <div class="mb-3">
    <a href="{% url 'backlog_lista' %}" class="btn btn-neusi me-2">Ver Backlog</a>
    <a href="{% url 'backlog_matriz' %}" class="btn btn-blue">Ver Matriz</a>
  </div>

  <!-- Tabla -->
  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Integrante</th>
            <th>Fecha</th>
            <th>Ayer</th>
            <th>Hoy</th>
            <th>Impedimentos</th>
            <th>Estado</th>
            {% if tiene_permisos_admin %}<th class="text-end">Acciones</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for d in registros %}
          <tr class="{% if d.fuera_horario %}table-soft-warning{% endif %}">
            <td class="fw-semibold">{{ d.integrante.user.first_name }}</td>
            <td class="fw-semibold">{{ d.fecha }}</td>
            <td>{{ d.que_hizo_ayer|default:"—" }}</td>
            <td>{{ d.que_hara_hoy|default:"—" }}</td>
            <td>{{ d.impedimentos|default:"—" }}</td>
            <td>
              {% if d.fuera_horario %}
                <span class="chip-warn">Fuera de horario</span>
              {% else %}
                <span class="chip-ok">En horario</span>
              {% endif %}
              {% if d.metricas %}
                <div class="mini-metric">
                  <span class="metric-badge">{{ d.metricas.porcentaje }}%</span>
                  <span class="ms-1">Alineación ({{ d.metricas.alineados }}/{{ d.metricas.total }})</span>
                </div>
              {% endif %}
            </td>
            {% if tiene_permisos_admin %}
            <td class="text-end">
              <a href="{% url 'eliminar_daily' d.id %}" class="btn btn-coral btn-sm">Eliminar</a>
            </td>
            {% endif %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">No hay registros de daily.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
