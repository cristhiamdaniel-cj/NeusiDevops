{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ğŸ“… Daily - NEUSI Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background: linear-gradient(180deg,#ede3ff 0%,#f9f7ff 100%); font-family: 'Segoe UI',system-ui,sans-serif; }
    :root{
      --neusi-purple:#6B4EFF; --neusi-purple-700:#5b40e0;
      --neusi-coral:#FF6B6B;  --neusi-coral-700:#ff5252;
      --neusi-blue:#00B3FF;   --neusi-blue-700:#009de0;
      --chip:#efeaff; --chip-t:#3d2fb0;
    }
    .btn-neusi{ background:var(--neusi-purple); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-neusi:hover{ background:var(--neusi-purple-700); }
    .btn-coral{ background:var(--neusi-coral); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-coral:hover{ background:var(--neusi-coral-700); }
    .btn-blue{ background:var(--neusi-blue); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-blue:hover{ background:var(--neusi-blue-700); }
    .card{ border:none; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .muted{ color:#6c757d; }
    .table thead th{ background:#f4f0ff; color:#3d2fb0; border-bottom:0; }
    .chip{ display:inline-block; background:var(--chip); color:var(--chip-t); padding:.15rem .55rem; border-radius:999px; font-weight:700; font-size:.8rem; }
  </style>
</head>
<body class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">ğŸ“… Daily de {{ integrante.user.first_name }} <span class="muted" style="font-size:.9rem">({{ fecha_actual }})</span></h2>
    {% if request.user.is_authenticated %}
      <div class="text-end">
        <a href="{% url 'home' %}" class="btn btn-neusi me-2">ğŸ  Home</a>
        <span class="fw-semibold me-2">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-coral">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    {% endif %}
  </div>

  <!-- Mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'warning' %}alert-warning{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if form.instance.fuera_horario %}
    <div class="alert alert-danger">
      âš  Este Daily fue registrado <strong>fuera del horario (5:00â€“9:00 AM)</strong>.
    </div>
  {% endif %}

  <!-- Cabecera (Ayer/Hoy/Impedimentos) -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label for="{{ form.que_hizo_ayer.id_for_label }}" class="form-label">âœ… Â¿QuÃ© hiciste ayer?</label>
          {{ form.que_hizo_ayer }}
          {{ form.que_hizo_ayer.errors }}
        </div>

        <div class="mb-3">
          <label for="{{ form.que_hara_hoy.id_for_label }}" class="form-label">ğŸš€ Â¿QuÃ© harÃ¡s hoy?</label>
          {{ form.que_hara_hoy }}
          {{ form.que_hara_hoy.errors }}
        </div>

        <!-- Enlace rÃ¡pido para HOY (solo Tarea/Subtarea, sin minutos ni evidencia) -->
        <div class="p-3 rounded mb-3" style="background:#f7f7ff;border:1px solid #ecebff;">
          <div class="row g-2">
            <div class="col-12 col-md-3">
              <label class="form-label">Enlazar con</label>
              <select id="link-tipo" class="form-select">
                <option value="">â€” Sin enlace â€”</option>
                <option value="tarea">Tarea</option>
                <option value="subtarea">Subtarea</option>
              </select>
            </div>
            <div class="col-12 col-md-5">
              <label class="form-label">Tarea (asignadas a ti)</label>
              <select id="sel-tarea" class="form-select" disabled>
                <option value="">â€” Selecciona â€”</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Subtarea (asignadas a ti)</label>
              <select id="sel-subtarea" class="form-select" disabled>
                <option value="">â€” Selecciona â€”</option>
              </select>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button id="btn-add-hoy" type="button" class="btn btn-blue">â• Guardar lÃ­nea de HOY</button>
          </div>
          <div class="form-text mt-2">
            Puedes dejar â€œSin enlaceâ€ para registrar una lÃ­nea libre. Cuando existan endpoints de opciones, las listas se llenarÃ¡n automÃ¡ticamente.
          </div>
        </div>

        <div class="mb-3">
          <label for="{{ form.impedimentos.id_for_label }}" class="form-label">âš  Impedimentos</label>
          {{ form.impedimentos }}
          <div class="form-text">Si no tienes impedimentos, deja este campo en blanco.</div>
          {{ form.impedimentos.errors }}
        </div>

        <button type="submit" class="btn btn-blue">ğŸ’¾ Guardar encabezado</button>
      </form>
    </div>
  </div>

  <!-- LÃ­neas de Daily (listado) -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">LÃ­neas del Daily</h4>
        <small class="muted">Cada lÃ­nea de HOY puede estar enlazada con una Tarea/Subtarea.</small>
      </div>

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:90px;">Tipo</th>
              <th>DescripciÃ³n</th>
              <th style="width:260px;">Tarea/Subtarea</th>
              <th style="width:110px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="items-body">
            <tr><td colspan="4" class="text-center text-muted py-4">Cargandoâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- NavegaciÃ³n inferior -->
  <div class="d-flex gap-2">
    <a href="{% url 'backlog_lista' %}" class="btn btn-neusi">ğŸ“‹ Ver Backlog</a>
    <a href="{% url 'daily_resumen' %}" class="btn btn-blue">ğŸ“ Ver Resumen Daily</a>
  </div>

  <!-- Config para JS (evitamos NoReverseMatch en endpoints inexistentes) -->
<div id="cfg"
     data-daily="{{ daily.id }}"
     data-url-list="{% url 'daily_items_json' daily.id %}"
     data-url-create="{% url 'dailyitem_create' daily.id %}"
     data-url-edit-template="{% url 'dailyitem_edit' 999999 %}"
     data-url-del-template="{% url 'dailyitem_delete' 999999 %}"
     data-url-tareas="{% url 'daily_tareas_opciones' %}"
     data-url-subtareas="{% url 'daily_subtareas_opciones' %}">
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    // --------- Config ---------
    const cfg = document.getElementById('cfg').dataset;
    const DAILY_ID   = Number(cfg.daily);
    const URL_LIST   = cfg.urlList;
    const URL_CREATE = cfg.urlCreate;
    const urlEdit    = (id)=> cfg.urlEditTemplate.replace("999999", id);
    const urlDel     = (id)=> cfg.urlDelTemplate.replace("999999", id);

    // si aÃºn no has creado endpoints, quedarÃ¡n como '' y no se intentarÃ¡ cargar
    const URL_TAREAS_OPTS    = cfg.urlTareas || "";
    const URL_SUBTAREAS_OPTS = cfg.urlSubtareas || "";

    // --------- DOM ---------
    const $tbody      = document.getElementById('items-body');
    const $queHaras   = document.getElementById('{{ form.que_hara_hoy.id_for_label }}')?.closest('form')
                        ?.querySelector('[name="{{ form.que_hara_hoy.name }}"]');
    const $linkTipo   = document.getElementById('link-tipo');
    const $selTarea   = document.getElementById('sel-tarea');
    const $selSubt    = document.getElementById('sel-subtarea');
    const $btnAddHoy  = document.getElementById('btn-add-hoy');

    // --------- Helpers ---------
    function getCsrf(){
      const name='csrftoken';
      const match = document.cookie.split('; ').find(row=>row.startsWith(name+'='));
      return match ? decodeURIComponent(match.split('=')[1]) : '';
    }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
    function fillSelect(sel, data){
      sel.innerHTML = '<option value="">â€” Selecciona â€”</option>';
      (data||[]).forEach(o=>{
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = o.titulo || o.nombre || ('#'+o.id);
        sel.appendChild(opt);
      });
    }

    function refreshLinkInputs(){
      const v = $linkTipo.value;
      $selTarea.disabled = v !== 'tarea';
      $selSubt.disabled  = v !== 'subtarea';
      if(v==='tarea'){ $selSubt.value=''; }
      if(v==='subtarea'){ $selTarea.value=''; }
      if(!v){ $selTarea.value=''; $selSubt.value=''; }
    }
    $linkTipo.addEventListener('change', refreshLinkInputs);

    // --------- Cargar opciones (tareas/subtareas asignadas) ---------
    async function loadOptions(){
      try{
        if(URL_TAREAS_OPTS){
          const rt = await fetch(URL_TAREAS_OPTS, {credentials:'same-origin'});
          if(rt.ok){ fillSelect($selTarea, await rt.json()); }
        }
        if(URL_SUBTAREAS_OPTS){
          const rs = await fetch(URL_SUBTAREAS_OPTS, {credentials:'same-origin'});
          if(rs.ok){ fillSelect($selSubt, await rs.json()); }
        }
      }catch(_e){ /* silencioso */ }
    }

    // --------- Listado ---------
    async function renderItems(){
      $tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">Cargandoâ€¦</td></tr>';
      const r = await fetch(URL_LIST, {credentials:'same-origin'});
      if(!r.ok){ $tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">Error cargando lÃ­neas.</td></tr>'; return; }
      const data = await r.json();
      const rows = (data.items||[]).map(i=>{
        const linkTxt = i.tarea_id ? `Tarea #${i.tarea_id}` : (i.subtarea_id ? `Subtarea #${i.subtarea_id}` : 'â€”');
        return `
          <tr>
            <td>${i.tipo}</td>
            <td>${escapeHtml(i.descripcion||'')}</td>
            <td>${linkTxt} ${(i.tarea_id||i.subtarea_id)?'<span class="chip ms-1">OK</span>':''}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-coral" data-del="${i.id}">Eliminar</button>
            </td>
          </tr>`;
      }).join('');
      $tbody.innerHTML = rows || '<tr><td colspan="4" class="text-center text-muted py-4">Sin lÃ­neas aÃºn.</td></tr>';

      // eliminar
      $tbody.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('Â¿Eliminar esta lÃ­nea?')) return;
          const id = btn.getAttribute('data-del');
          await fetch(urlDel(id), {method:'POST', headers:{'X-CSRFToken':getCsrf()}, credentials:'same-origin'});
          renderItems();
        });
      });
    }

    // --------- Crear lÃ­nea de HOY ---------
    $btnAddHoy.addEventListener('click', async ()=>{
      const payload = new URLSearchParams();
      payload.append('tipo','HOY');
      // descripciÃ³n: si escribieron plan del dÃ­a, lo usamos; si no, se puede dejar vacÃ­o cuando hay enlace
      const desc = ($queHaras && $queHaras.value || '').trim();
      if(desc) payload.append('descripcion', desc);

      if($linkTipo.value==='tarea' && $selTarea.value){ payload.append('tarea_id', $selTarea.value); }
      if($linkTipo.value==='subtarea' && $selSubt.value){ payload.append('subtarea_id', $selSubt.value); }

      const r = await fetch(URL_CREATE, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCsrf()},
        body:payload.toString(),
        credentials:'same-origin'
      });
      const j = await r.json().catch(()=>({}));
      if(r.ok){
        // limpiar solo el enlace; no borramos â€œquÃ© harÃ¡s hoyâ€
        $linkTipo.value=''; refreshLinkInputs();
        renderItems();
      }else{
        alert(j.error || 'No se pudo crear la lÃ­nea.');
      }
    });

    // --------- Init ---------
    refreshLinkInputs();
    loadOptions();
    renderItems();
  })();
  </script>
</body>
</html>
