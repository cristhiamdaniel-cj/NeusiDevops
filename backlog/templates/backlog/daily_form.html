{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>ğŸ“… Daily - NEUSI Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background: linear-gradient(180deg,#ede3ff 0%,#f9f7ff 100%); font-family: 'Segoe UI',system-ui,sans-serif; }
    :root{
      --neusi-purple:#6B4EFF; --neusi-purple-700:#5b40e0;
      --neusi-coral:#FF6B6B;  --neusi-coral-700:#ff5252;
      --neusi-blue:#00B3FF;   --neusi-blue-700:#009de0;
      --chip:#efeaff; --chip-t:#3d2fb0; --muted:#6c757d;
    }
    .btn-neusi{ background:var(--neusi-purple); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-neusi:hover{ background:var(--neusi-purple-700); }
    .btn-coral{ background:var(--neusi-coral); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-coral:hover{ background:var(--neusi-coral-700); }
    .btn-blue{ background:var(--neusi-blue); color:#fff!important; border:none; border-radius:10px; font-weight:600; }
    .btn-blue:hover{ background:var(--neusi-blue-700); }
    .btn-icon{ display:inline-flex; align-items:center; gap:.45rem; }
    .card{ border:none; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .muted{ color:var(--muted); }
    .table thead th{ background:#f4f0ff; color:#3d2fb0; border-bottom:0; }
    .chip{ display:inline-block; background:var(--chip); color:var(--chip-t); padding:.15rem .55rem; border-radius:999px; font-weight:700; font-size:.8rem; }
  </style>
</head>
<body class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">ğŸ“… Daily de {{ integrante.user.first_name }} <span class="muted" style="font-size:.9rem">({{ fecha_actual }})</span></h2>
    {% if request.user.is_authenticated %}
      <div class="text-end">
        <a href="{% url 'home' %}" class="btn btn-neusi me-2 btn-icon">ğŸ  <span>Home</span></a>
        <span class="fw-semibold me-2">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-coral btn-icon">ğŸšª <span>Cerrar SesiÃ³n</span></a>
      </div>
    {% endif %}
  </div>

  <!-- Mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'warning' %}alert-warning{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if form.instance.fuera_horario %}
    <div class="alert alert-danger">
      âš  Este Daily fue registrado <strong>fuera del horario (5:00â€“9:00 AM)</strong>.
    </div>
  {% endif %}

  <!-- Formulario Ãºnico (header + enlace opcional) -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label for="{{ form.que_hizo_ayer.id_for_label }}" class="form-label">âœ… Â¿QuÃ© hiciste ayer?</label>
          {{ form.que_hizo_ayer }}
          {{ form.que_hizo_ayer.errors }}
        </div>

        <div class="mb-3">
          <label for="{{ form.que_hara_hoy.id_for_label }}" class="form-label">ğŸš€ Â¿QuÃ© harÃ¡s hoy?</label>
          {{ form.que_hara_hoy }}
          {{ form.que_hara_hoy.errors }}
        </div>

        <!-- Enlace rÃ¡pido (viaja en el mismo POST) -->
        <div class="p-3 rounded mb-3" style="background:#f7f7ff;border:1px solid #ecebff;">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
              <label class="form-label">Enlazar con</label>
              <select id="link-tipo" name="link_tipo" class="form-select">
                <option value="">â€” Sin enlace â€”</option>
                <option value="tarea">Tarea</option>
                <option value="subtarea">Subtarea</option>
              </select>
            </div>
            <div class="col-12 col-md-5">
              <label class="form-label">Tarea (asignadas a ti)</label>
              <select id="sel-tarea" name="tarea_id" class="form-select" disabled>
                <option value="">â€” Selecciona â€”</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Subtarea (asignadas a ti)</label>
              <select id="sel-subtarea" name="subtarea_id" class="form-select" disabled>
                <option value="">â€” Selecciona â€”</option>
              </select>
            </div>
          </div>
          <div class="form-text mt-2">
            Si eliges â€œTareaâ€ o â€œSubtareaâ€, al guardar se crearÃ¡ automÃ¡ticamente la <strong>lÃ­nea de HOY</strong> enlazada con tu descripciÃ³n.
          </div>
        </div>

        <div class="mb-3">
          <label for="{{ form.impedimentos.id_for_label }}" class="form-label">âš  Impedimentos</label>
          {{ form.impedimentos }}
          <div class="form-text">Si no tienes impedimentos, deja este campo en blanco.</div>
          {{ form.impedimentos.errors }}
        </div>

        <button type="submit" class="btn btn-blue btn-icon">ğŸ’¾ <span>Guardar</span></button>
      </form>
    </div>
  </div>

  <!-- Si ya existe Daily, muestra lÃ­neas actuales -->
  {% if daily %}
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">LÃ­neas del Daily</h4>
        <small class="muted">Cada lÃ­nea de HOY puede estar enlazada con una Tarea/Subtarea.</small>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:90px;">Tipo</th>
              <th>DescripciÃ³n</th>
              <th style="width:260px;">Tarea/Subtarea</th>
            </tr>
          </thead>
          <tbody>
            {% with items=daily.items.all %}
              {% if items %}
                {% for i in items %}
                  <tr>
                    <td>{{ i.tipo }}</td>
                    <td>{{ i.descripcion|default:"â€”" }}</td>
                    <td>
                      {% if i.tarea_id %}Tarea #{{ i.tarea_id }}{% elif i.subtarea_id %}Subtarea #{{ i.subtarea_id }}{% else %}â€”{% endif %}
                      {% if i.tarea_id or i.subtarea_id %}<span class="chip ms-1">OK</span>{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="text-center text-muted py-4">Sin lÃ­neas aÃºn.</td></tr>
              {% endif %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- NavegaciÃ³n inferior -->
  <div class="d-flex gap-2">
    <a href="{% url 'backlog_lista' %}" class="btn btn-neusi btn-icon">ğŸ“‹ <span>Ver Backlog</span></a>
    <a href="{% url 'daily_resumen' %}" class="btn btn-blue btn-icon">ğŸ“ <span>Ver Resumen Daily</span></a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Poblar combos de tareas/subtareas (no dependen del daily_id)
  (function(){
    const $tipo = document.getElementById('link-tipo');
    const $tSel = document.getElementById('sel-tarea');
    const $sSel = document.getElementById('sel-subtarea');

    function toggle(){
      const v = $tipo.value;
      $tSel.disabled = v !== 'tarea';
      $sSel.disabled = v !== 'subtarea';
      if(v === 'tarea'){ $sSel.value=''; }
      if(v === 'subtarea'){ $tSel.value=''; }
      if(!v){ $tSel.value=''; $sSel.value=''; }
    }
    $tipo.addEventListener('change', toggle); toggle();

    function fill(sel, data){
      sel.innerHTML = '<option value="">â€” Selecciona â€”</option>';
      (data||[]).forEach(o=>{
        const op = document.createElement('option');
        op.value = o.id;
        op.textContent = o.titulo || o.nombre || ('#'+o.id);
        sel.appendChild(op);
      });
    }

    // Cargar opciones
    fetch("{% url 'daily_tareas_opciones' %}", {credentials:'same-origin'})
      .then(r => r.ok ? r.json() : [])
      .then(j => fill($tSel, j))
      .catch(()=>{});

    fetch("{% url 'daily_subtareas_opciones' %}", {credentials:'same-origin'})
      .then(r => r.ok ? r.json() : [])
      .then(j => fill($sSel, j))
      .catch(()=>{});
  })();
  </script>
</body>
</html>
