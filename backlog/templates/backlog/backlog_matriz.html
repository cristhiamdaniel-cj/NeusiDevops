{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Matriz de Eisenhower</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'backlog/backlog.css' %}?v=2">

  <style>
    .quadrant {
      min-height: 250px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 10px;
      background-color: #f8f9fa;
    }
    .card { margin-bottom: 8px; cursor: grab; }
    .card:active { cursor: grabbing; }
    .quadrant.drag-over { background-color: #e3f2fd; border-color: #0d6efd; }

    .btn { padding: 6px 12px; margin: 3px; border: none; border-radius: 5px; text-decoration: none; color: white; font-weight: bold; display: inline-block; }
    .btn-sm { padding: 4px 8px; font-size: 0.85em; }
    .btn-primary { background-color: #007bff; }
    .btn-secondary { background-color: #6c757d; }
    .btn-danger { background-color: #dc3545; }
    .btn-info { background-color: #17a2b8; }
    .btn-delete { background-color: #8B0000; }

    .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { text-align: right; }
    .task-actions { margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; }
    .task-content { cursor: grab; }

    /* ğŸ”¹ badge de Ã©pica */
    .badge-epica {
      background-color: #0d6efd; color: #fff; padding: 3px 6px; border-radius: 3px; font-size: 0.75em;
      text-decoration: none;
    }
  </style>
</head>
<body class="container mt-4">

  <div class="header-container">
    <h2>ğŸ“Š Backlog de NEUSI (Matriz de Eisenhower)</h2>
    {% if request.user.is_authenticated %}
      <div class="user-info">
        <a href="{% url 'home' %}" class="btn btn-secondary">ğŸ  Home</a>
        <span style="margin: 0 15px;">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-danger">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    {% endif %}
  </div>

  <div class="mb-3">
    <a href="{% url 'daily_personal' %}" class="btn btn-primary">ğŸ“… Mi Daily</a>
    <a href="{% url 'backlog_lista' %}" class="btn btn-secondary">ğŸ“‹ Ver en Lista</a>
  </div>

  <!-- ======= Filtros (por defecto oculta cerradas y sprints viejos) ======= -->
  <div class="p-3 mb-3" style="background:#eef2ff;border-radius:10px;border:1px solid #dde3ff;">
    <form method="get" class="row g-3 align-items-end">
      {% if tiene_permisos_admin %}
        <div class="col-12 col-md-3">
          <label class="form-label">ğŸ‘¤ Persona</label>
          <select name="persona" class="form-select" onchange="this.form.submit()">
            <option value="">â€” Todas â€”</option>
            {% for i in integrantes %}
              <option value="{{ i.id }}" {% if persona_id == i.id|stringformat:"s" %}selected{% endif %}>
                {{ i.user.first_name }} {{ i.user.last_name }}
              </option>
            {% endfor %}
          </select>
        </div>
      {% endif %}

      <div class="col-12 col-md-3">
        <label class="form-label">ğŸ—“ Sprint</label>
        <select name="sprint" class="form-select" onchange="this.form.submit()">
          <option value="">â€” Actuales por defecto â€”</option>
          {% for s in sprints %}
            <option value="{{ s.id }}" {% if sprint_id == s.id|stringformat:"s" %}selected{% endif %}>
              {{ s.nombre }} ({{ s.inicio }} â€” {{ s.fin }})
            </option>
          {% endfor %}
        </select>
        <div class="form-text">Por defecto se muestran sprints vigentes o con fin â‰¤ 2 dÃ­as.</div>
      </div>

      <div class="col-6 col-md-3 form-check mt-4">
        <input class="form-check-input" type="checkbox" id="inc" name="include_closed" value="1" {% if include_closed %}checked{% endif %} onchange="this.form.submit()">
        <label class="form-check-label" for="inc">Incluir tareas cerradas</label>
      </div>

      <div class="col-6 col-md-3 form-check mt-4">
        <input class="form-check-input" type="checkbox" id="old" name="show_old" value="1" {% if show_old %}checked{% endif %} onchange="this.form.submit()">
        <label class="form-check-label" for="old">Mostrar sprints antiguos</label>
      </div>

      {% if persona_id or sprint_id or include_closed or show_old %}
        <div class="col-12">
          <a href="{% url 'backlog_matriz' %}" class="btn btn-danger btn-sm">âŒ Limpiar filtros</a>
        </div>
      {% endif %}
    </form>
  </div>

  <!-- ======= Cuadrantes ======= -->
  <div class="row g-3">
    <!-- UI -->
    <div class="col-md-6">
      <div class="quadrant" id="ui">
        <h5>ğŸ”¥ Urgente e Importante</h5>
        {% for tarea in ui %}
          <div class="card p-2 bg-white shadow-sm" draggable="true" data-id="{{ tarea.id }}">
            <div class="task-content">
              <strong>{{ tarea.titulo }}</strong><br>
              {% if tarea.epica %}
                <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a><br>
              {% endif %}
              ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a }}{% else %}â€”{% endif %}<br>
              ğŸ—“ Sprint: {{ tarea.sprint }}
            </div>
            <div class="task-actions">
              <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
              {% if tiene_permisos_admin %}
                <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸ Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸ Eliminar</a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>âš  Nada en este cuadrante.</p>
        {% endfor %}
      </div>
    </div>

    <!-- NUI -->
    <div class="col-md-6">
      <div class="quadrant" id="nui">
        <h5>ğŸ“Š No Urgente e Importante</h5>
        {% for tarea in nui %}
          <div class="card p-2 bg-white shadow-sm" draggable="true" data-id="{{ tarea.id }}">
            <div class="task-content">
              <strong>{{ tarea.titulo }}</strong><br>
              {% if tarea.epica %}
                <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a><br>
              {% endif %}
              ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a }}{% else %}â€”{% endif %}<br>
              ğŸ—“ Sprint: {{ tarea.sprint }}
            </div>
            <div class="task-actions">
              <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
              {% if tiene_permisos_admin %}
                <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸ Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸ Eliminar</a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>âš  Nada en este cuadrante.</p>
        {% endfor %}
      </div>
    </div>

    <!-- UNI -->
    <div class="col-md-6">
      <div class="quadrant" id="uni">
        <h5>âš¡ Urgente y No Importante</h5>
        {% for tarea in uni %}
          <div class="card p-2 bg-white shadow-sm" draggable="true" data-id="{{ tarea.id }}">
            <div class="task-content">
              <strong>{{ tarea.titulo }}</strong><br>
              {% if tarea.epica %}
                <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a><br>
              {% endif %}
              ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a }}{% else %}â€”{% endif %}<br>
              ğŸ—“ Sprint: {{ tarea.sprint }}
            </div>
            <div class="task-actions">
              <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
              {% if tiene_permisos_admin %}
                <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸ Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸ Eliminar</a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>âš  Nada en este cuadrante.</p>
        {% endfor %}
      </div>
    </div>

    <!-- NUNI -->
    <div class="col-md-6">
      <div class="quadrant" id="nuni">
        <h5>ğŸ No Urgente y No Importante</h5>
        {% for tarea in nuni %}
          <div class="card p-2 bg-white shadow-sm" draggable="true" data-id="{{ tarea.id }}">
            <div class="task-content">
              <strong>{{ tarea.titulo }}</strong><br>
              {% if tarea.epica %}
                <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a><br>
              {% endif %}
              ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a }}{% else %}â€”{% endif %}<br>
              ğŸ—“ Sprint: {{ tarea.sprint }}
            </div>
            <div class="task-actions">
              <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
              {% if tiene_permisos_admin %}
                <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸ Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸ Eliminar</a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p>âš  Nada en este cuadrante.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    // Drag & Drop
    let draggedCard = null;

    document.querySelectorAll(".card[draggable='true']").forEach(card => {
      card.addEventListener("dragstart", e => {
        if (e.target.tagName === 'A') { e.preventDefault(); return; }
        draggedCard = card;
        e.dataTransfer.effectAllowed = "move";
        card.style.opacity = "0.5";
      });
      card.addEventListener("dragend", () => { card.style.opacity = "1"; });
    });

    document.querySelectorAll(".quadrant").forEach(quad => {
      quad.addEventListener("dragover", e => { e.preventDefault(); quad.classList.add("drag-over"); });
      quad.addEventListener("dragleave", () => quad.classList.remove("drag-over"));
      quad.addEventListener("drop", e => {
        e.preventDefault();
        quad.classList.remove("drag-over");
        if (!draggedCard) return;

        quad.appendChild(draggedCard);

        const tareaId = draggedCard.dataset.id;
        const nuevaCategoria = quad.id.toUpperCase(); // UI, NUI, UNI, NUNI

        // ğŸ”¹ Server: cambiar categorÃ­a (no estado)
        fetch(`/tarea/${tareaId}/cambiar-categoria/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ categoria: nuevaCategoria })
        })
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            alert('Error: ' + (data.error || 'No se pudo actualizar'));
            location.reload();
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Error al mover la tarea. Recarga la pÃ¡gina.');
          location.reload();
        });
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
