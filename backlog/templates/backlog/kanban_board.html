{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Kanban Board - NEUSI Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { background: transparent !important; }
    body::before{ content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1200px 600px at 10% -10%, #ead6ff, transparent 60%),
        radial-gradient(1200px 600px at 110% 10%, #e6dbff, transparent 60%), #f4efff; }
    body > *{ position:relative; z-index:2; }

    .header-container{ max-width:1100px; margin:0 auto 20px; padding:0 16px; display:flex; justify-content:space-between; align-items:center; }
    .header-container h2{ margin:0; font-weight:800; color:#5b21b6; }

    .btn{ border:none; border-radius:10px; font-weight:800; padding:8px 14px; }
    .btn-primary{ background:#3b82f6; color:#111 !important; }
    .btn-secondary{ background:#7c3aed; color:#111 !important; }
    .btn-danger{ background:#dc3545; color:#fff !important; }
    .btn-info{ background:#17a2b8; color:#fff; }
    .btn-delete{ background:#8B0000; color:#fff; }

    .filters-wrap{ max-width:1100px; margin:15px auto 0; padding:15px; background:#eef2ff; border:1px solid #e6e8ee; border-radius:16px; box-shadow:0 6px 16px rgba(32,44,80,.06); }
    .filters-wrap form{ display:flex; flex-wrap:wrap; gap:12px 16px; align-items:center; }

    .kanban-container{ max-width:1300px; margin:0 auto; padding:20px 16px 40px; display:flex; gap:18px; overflow-x:auto; }
    .kanban-column{ min-width:280px; flex:1; background:#fff; border:1px solid #e6e8ee; border-radius:16px; padding:15px; box-shadow:0 10px 24px rgba(32,44,80,.08); }
    .kanban-column h5{ margin-bottom:14px; font-weight:800; text-align:center; padding:10px; background:#fff; border-radius:10px; border:1px solid #eef0f6; }
    .column-nuevo{ border-top:4px solid #6b7280; }
    .column-en-progreso{ border-top:4px solid #f59e0b; }
    .column-completado{ border-top:4px solid #22c55e; }
    .column-bloqueado{ border-top:4px solid #dc3545; }

    .task-card{ background:#fff; border-radius:12px; border:1px solid #eef0f6; padding:12px; margin-bottom:10px; cursor:grab; box-shadow:0 2px 4px rgba(0,0,0,.06); transition: transform .15s ease, box-shadow .15s ease; }
    .task-card:hover{ transform: translateY(-2px); box-shadow:0 6px 16px rgba(32,44,80,.12); }
    .task-card.dragging{ opacity:.5; }
    .task-title{ font-weight:800; margin-bottom:6px; color:#111827; }
    .task-meta{ font-size:.88rem; color:#596275; margin:4px 0; }
    .task-actions{ margin-top:10px; padding-top:8px; border-top:1px solid #eef0f6; }

    .kanban-column.drag-over{ background: linear-gradient(#f8fbff, #eef6ff); border:2px dashed #0d6efd; }

    .badge-ui{background:#dc3545;color:#fff;padding:3px 6px;border-radius:6px;font-size:.75em;}
    .badge-nui{background:#6b7280;color:#fff;padding:3px 6px;border-radius:6px;font-size:.75em;}
    .badge-uni{background:#f59e0b;color:#111;padding:3px 6px;border-radius:6px;font-size:.75em;}
    .badge-epica{background:#0d6efd;color:#fff;padding:3px 6px;border-radius:6px;font-size:.73em;text-decoration:none;}

    @media (max-width: 992px){ .header-container{flex-direction:column;gap:10px;text-align:center;} .filters-wrap{border-radius:12px;} }
  </style>
</head>
<body class="container-fluid mt-4">

  <div class="header-container">
    <h2>ğŸ“‹ Kanban Board - NEUSI Task Manager</h2>
    {% if request.user.is_authenticated %}
      <div>
        <a href="{% url 'home' %}" class="btn btn-secondary">ğŸ  Home</a>
        <span style="margin: 0 15px;">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
        <a href="{% url 'logout' %}" class="btn btn-danger">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    {% endif %}
  </div>

  <div class="mb-3">
    <a href="{% url 'daily_personal' %}" class="btn btn-primary">ğŸ“… Mi Daily</a>
    <a href="{% url 'backlog_lista' %}" class="btn btn-secondary">ğŸ“‹ Ver en Lista</a>
    <a href="{% url 'backlog_matriz' %}" class="btn btn-secondary">ğŸ“Š Ver Matriz</a>
  </div>

  <!-- Filtros -->
  <div class="filters-wrap">
    <form method="get">
      {% if puede_ver_todo %}
        <label for="persona" class="fw-semibold">Persona:</label>
        <select name="persona" id="persona" onchange="this.form.submit()">
          <option value="">â€” Todas â€”</option>
          {% for i in integrantes %}
            <option value="{{ i.id }}" {% if persona_id == i.id|stringformat:"s" %}selected{% endif %}>
              {{ i.user.first_name }} {{ i.user.last_name }}
            </option>
          {% endfor %}
        </select>

        <label for="epica" class="fw-semibold ms-2">Ã‰pica:</label>
        <select name="epica" id="epica" onchange="this.form.submit()">
          <option value="">â€” Todas â€”</option>
          {% for e in epicas %}
            <option value="{{ e.id }}" {% if request.GET.epica == e.id|stringformat:"s" %}selected{% endif %}>
              {{ e.titulo }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      <label for="sprint" class="fw-semibold ms-2">Sprint:</label>
      <select name="sprint" id="sprint" onchange="this.form.submit()">
        <option value="">â€” Vigentes por defecto â€”</option>
        {% for s in sprints %}
          <option value="{{ s.id }}" {% if sprint_id == s.id|stringformat:"s" %}selected{% endif %}>
            {{ s.nombre }} ({{ s.inicio }} â€” {{ s.fin }})
          </option>
        {% endfor %}
      </select>

      <div class="form-check ms-3">
        <input class="form-check-input" type="checkbox" id="inc" name="include_closed" value="1" {% if include_closed %}checked{% endif %} onchange="this.form.submit()">
        <label class="form-check-label" for="inc">Incluir cerradas</label>
      </div>

      <div class="form-check ms-2">
        <input class="form-check-input" type="checkbox" id="old" name="show_old" value="1" {% if show_old %}checked{% endif %} onchange="this.form.submit()">
        <label class="form-check-label" for="old">Mostrar sprints antiguos</label>
      </div>

      {% if persona_id or request.GET.epica or sprint_id or include_closed or show_old %}
        <a href="{% url 'kanban_board' %}" class="btn btn-danger btn-sm ms-3">âŒ Limpiar</a>
      {% endif %}
    </form>
  </div>

  <div class="kanban-container">
    <!-- NUEVO -->
    <div class="kanban-column column-nuevo" data-estado="NUEVO">
      <h5>ğŸ“ Nuevo</h5>
      {% for tarea in nuevo %}
        <div class="task-card" draggable="true"
             data-id="{{ tarea.id }}"
             data-estado="{{ tarea.estado }}"
             data-endpoint="{% url 'cambiar_estado_tarea' tarea.id %}">
          <div class="task-title">{{ tarea.titulo }}</div>

          {% if tarea.epica %}
            <div class="task-meta">
              <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a>
            </div>
          {% endif %}

          <div class="task-meta"><span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span></div>
          <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
          <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
          <div class="task-actions">
            <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
            {% if tiene_permisos_admin %}
              <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
              <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
            {% endif %}
          </div>
        </div>
      {% empty %}<p class="text-muted text-center">Sin tareas</p>{% endfor %}
    </div>

    <!-- EN PROGRESO -->
    <div class="kanban-column column-en-progreso" data-estado="EN_PROGRESO">
      <h5>âš™ï¸ En Progreso</h5>
      {% for tarea in en_progreso %}
        <div class="task-card" draggable="true"
             data-id="{{ tarea.id }}"
             data-estado="{{ tarea.estado }}"
             data-endpoint="{% url 'cambiar_estado_tarea' tarea.id %}">
          <div class="task-title">{{ tarea.titulo }}</div>
          {% if tarea.epica %}
            <div class="task-meta">
              <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a>
            </div>
          {% endif %}
          <div class="task-meta"><span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span></div>
          <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
          <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
          <div class="task-actions">
            <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
            {% if tiene_permisos_admin %}
              <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
              <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
            {% endif %}
          </div>
        </div>
      {% empty %}<p class="text-muted text-center">Sin tareas</p>{% endfor %}
    </div>

    <!-- COMPLETADO -->
    <div class="kanban-column column-completado" data-estado="COMPLETADO">
      <h5>ğŸ‰ Completado</h5>
      {% for tarea in completado %}
        <div class="task-card" draggable="true"
             data-id="{{ tarea.id }}"
             data-estado="{{ tarea.estado }}"
             data-endpoint="{% url 'cambiar_estado_tarea' tarea.id %}">
          <div class="task-title">{{ tarea.titulo }}</div>
          {% if tarea.epica %}
            <div class="task-meta">
              <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a>
            </div>
          {% endif %}
          <div class="task-meta"><span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span></div>
          <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
          <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
          <div class="task-actions">
            <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
            {% if tiene_permisos_admin %}
              <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
              <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
            {% endif %}
          </div>
        </div>
      {% empty %}<p class="text-muted text-center">Sin tareas</p>{% endfor %}
    </div>

    <!-- BLOQUEADO -->
    <div class="kanban-column column-bloqueado" data-estado="BLOQUEADO">
      <h5>ğŸš« Bloqueado</h5>
      {% for tarea in bloqueado %}
        <div class="task-card" draggable="true"
             data-id="{{ tarea.id }}"
             data-estado="{{ tarea.estado }}"
             data-endpoint="{% url 'cambiar_estado_tarea' tarea.id %}">
          <div class="task-title">{{ tarea.titulo }}</div>
          {% if tarea.epica %}
            <div class="task-meta">
              <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica">{{ tarea.epica.titulo }}</a>
            </div>
          {% endif %}
          <div class="task-meta"><span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span></div>
          <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
          <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
          <div class="task-actions">
            <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
            {% if tiene_permisos_admin %}
              <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
              <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
            {% endif %}
          </div>
        </div>
      {% empty %}<p class="text-muted text-center">Sin tareas</p>{% endfor %}
    </div>
  </div>

  <script>
    let draggedCard = null;

    document.querySelectorAll(".task-card").forEach(card => {
      card.addEventListener("dragstart", e => {
        if (e.target.tagName === 'A') { e.preventDefault(); return; }
        draggedCard = card;
        card.classList.add("dragging");
      });
      card.addEventListener("dragend", () => { card.classList.remove("dragging"); });
    });

    document.querySelectorAll(".kanban-column").forEach(column => {
      column.addEventListener("dragover", e => { e.preventDefault(); column.classList.add("drag-over"); });
      column.addEventListener("dragleave", () => { column.classList.remove("drag-over"); });
      column.addEventListener("drop", e => {
        e.preventDefault();
        column.classList.remove("drag-over");
        if (!draggedCard) return;

        const endpoint   = draggedCard.dataset.endpoint;
        const estadoPrev = (draggedCard.dataset.estado || "").toUpperCase();
        const nuevoEstado= column.dataset.estado;

        // Sin cambio real
        if (estadoPrev === nuevoEstado) {
          column.appendChild(draggedCard);
          return;
        }

        // ObservaciÃ³n opcional al pasar a EN_PROGRESO
        let observacion = "";
        if (nuevoEstado === "EN_PROGRESO") {
          observacion = window.prompt(
            "ObservaciÃ³n al devolver a 'En Progreso' (opcional):\nEj: Se devuelve a progreso por ajustes."
          ) || "";
          observacion = observacion.trim();
        }

        // Mover visualmente
        column.appendChild(draggedCard);

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ estado: nuevoEstado, observacion })
        })
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            alert('Error: ' + (data.error || 'Desconocido'));
            location.reload();
            return;
          }
          draggedCard.dataset.estado = nuevoEstado;
        })
        .catch(() => {
          alert('Error al actualizar el estado. Recarga la pÃ¡gina.');
          location.reload();
        });
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
