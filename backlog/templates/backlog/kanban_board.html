{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kanban Board - NEUSI Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
  /* ===============================
     Fondo lila tipo â€œnieblaâ€
     =============================== */
  html, body { background: transparent !important; }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    z-index:0;
    pointer-events:none;
    background:
      radial-gradient(1200px 600px at 10% -10%, #ead6ff, transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, #e6dbff, transparent 60%),
      #f4efff;
  }
  /* Asegura que todo el contenido quede por encima del fondo */
  body > *{ position:relative; z-index:2; }

  /* ===============================
     Layout de cabecera y acciones
     =============================== */
  .header-container{
    max-width: 1100px;
    margin: 0 auto 20px;
    padding: 0 16px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .header-container h2{
    margin: 0;
    font-weight:800;
    color:#5b21b6;
  }

  /* Botones coherentes con el resto */
  .btn{ border:none; border-radius:10px; font-weight:800; padding:8px 14px; }
  .btn-primary{ background:#3b82f6; color:#111 !important; }
  .btn-secondary{ background:#7c3aed; color:#111 !important; }
  .btn-danger{ background:#dc3545; color:#fff !important; }
  .btn-info{ background:#17a2b8; color:#fff; }
  .btn-delete{ background:#8B0000; color:#fff; }

  /* Contenedor de filtros */
  .mb-3 > div{
    max-width:1100px;
    margin: 15px auto 0;
    padding: 15px;
    background:#eef2ff;                /* suave lila */
    border:1px solid #e6e8ee;
    border-radius:16px;
    box-shadow:0 6px 16px rgba(32,44,80,.06);
  }
  .mb-3 form{ display:flex; flex-wrap:wrap; gap:12px 16px; align-items:center; }

  /* ===============================
     Kanban
     =============================== */
  .kanban-container{
    max-width: 1300px;
    margin: 0 auto;
    padding: 20px 16px 40px;
    display:flex;
    gap: 18px;
    overflow-x:auto;
  }
  .kanban-column{
    min-width: 280px;
    flex: 1;
    background:#fff;                   /* tarjeta blanca */
    border:1px solid #e6e8ee;
    border-radius:16px;
    padding: 15px;
    box-shadow:0 10px 24px rgba(32,44,80,.08);
  }
  .kanban-column h5{
    margin-bottom: 14px;
    font-weight:800;
    text-align:center;
    padding:10px;
    background:#fff;
    border-radius:10px;
    border:1px solid #eef0f6;
  }
  /* Colores de â€œborde superiorâ€ por estado */
  .column-nuevo{        border-top: 4px solid #6b7280; }
  .column-aprobado{     border-top: 4px solid #0d6efd; }
  .column-en-progreso{  border-top: 4px solid #f59e0b; }
  .column-completado{   border-top: 4px solid #22c55e; }
  .column-bloqueado{    border-top: 4px solid #dc3545; }

  /* Tarjetas */
  .task-card{
    background:#fff;
    border-radius:12px;
    border:1px solid #eef0f6;
    padding:12px;
    margin-bottom:10px;
    cursor:grab;
    box-shadow:0 2px 4px rgba(0,0,0,.06);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .task-card:hover{ transform: translateY(-2px); box-shadow:0 6px 16px rgba(32,44,80,.12); }
  .task-card:active{ cursor:grabbing; }
  .task-card.dragging{ opacity:.5; }

  .task-title{ font-weight:800; margin-bottom:6px; color:#111827; }
  .task-meta{ font-size:.88rem; color:#596275; margin: 4px 0; }
  .task-actions{ margin-top:10px; padding-top:8px; border-top:1px solid #eef0f6; }

  /* Estado de drop */
  .kanban-column.drag-over{
    background: linear-gradient(#f8fbff, #eef6ff);
    border:2px dashed #0d6efd;
  }

  /* Badges de categorÃ­a/Ã©pica */
  .badge-ui  { background:#dc3545; color:#fff; padding:3px 6px; border-radius:6px; font-size:.75em; }
  .badge-nui { background:#6b7280; color:#fff; padding:3px 6px; border-radius:6px; font-size:.75em; }
  .badge-uni { background:#f59e0b; color:#111; padding:3px 6px; border-radius:6px; font-size:.75em; }
  .badge-nui { background:#6b7280; color:#fff; padding:3px 6px; border-radius:6px; font-size:.75em; }
  .badge-epica{ background:#0d6efd; color:#fff; padding:3px 6px; border-radius:6px; font-size:.73em; text-decoration:none; }

  /* Responsive */
  @media (max-width: 992px){
    .header-container{ flex-direction:column; gap:10px; text-align:center; }
    .mb-3 > div{ border-radius:12px; }
  }
</style>

</head>
<body class="container-fluid mt-4">

    <div class="header-container">
        <h2>ğŸ“‹ Kanban Board - NEUSI Task Manager</h2>
        
        {% if request.user.is_authenticated %}
        <div>
            <a href="{% url 'home' %}" class="btn btn-secondary">ğŸ  Home</a>
            <span style="margin: 0 15px;">ğŸ‘¤ {{ request.user.first_name|default:request.user.username }}</span>
            <a href="{% url 'logout' %}" class="btn btn-danger">ğŸšª Cerrar SesiÃ³n</a>
        </div>
        {% endif %}
    </div>

    <div class="mb-3">
        <a href="{% url 'daily_personal' %}" class="btn btn-primary">ğŸ“… Mi Daily</a>
        <a href="{% url 'backlog_lista' %}" class="btn btn-secondary">ğŸ“‹ Ver en Lista</a>
        <a href="{% url 'backlog_matriz' %}" class="btn btn-secondary">ğŸ“Š Ver Matriz</a>
        
        {% if tiene_permisos_admin %}
        <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px;">
            <form method="get" style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                <!-- Filtro persona -->
                <label for="persona">Filtrar por persona:</label>
                <select name="persona" id="persona" onchange="this.form.submit()">
                    <option value="">-- Todas las personas --</option>
                    {% for i in integrantes %}
                        <option value="{{ i.id }}" {% if persona_id == i.id|stringformat:"s" %}selected{% endif %}>
                            {{ i.user.first_name }} {{ i.user.last_name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- ğŸ”¹ Nuevo: filtro por Ã‰pica -->
                <label for="epica">Ã‰pica:</label>
                <select name="epica" id="epica" onchange="this.form.submit()">
                    <option value="">-- Todas --</option>
                    {% for e in epicas %}
                        <option value="{{ e.id }}">{{ e.titulo }}</option>
                    {% endfor %}
                </select>

                {% if persona_id or request.GET.epica %}
                    <a href="{% url 'kanban_board' %}" class="btn btn-danger btn-sm">âŒ Limpiar</a>
                {% endif %}
            </form>
        </div>
        {% else %}
        <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border-radius: 5px; border: 1px solid #bee5eb;">
            <strong style="color: #0c5460;">ğŸ’¡ Instrucciones:</strong> 
            <span style="color: #0c5460;">Arrastra tus tareas entre las columnas para cambiar su estado.</span>
        </div>
        {% endif %}
    </div>

    <div class="kanban-container">
        <!-- Columna: NUEVO -->
        <div class="kanban-column column-nuevo" data-estado="NUEVO">
            <h5>ğŸ“ Nuevo</h5>
            {% for tarea in nuevo %}
                <div class="task-card" draggable="true" data-id="{{ tarea.id }}">
                    <div class="task-title">{{ tarea.titulo }}</div>

                    <!-- ğŸ”¹ Badge Ã‰pica -->
                    {% if tarea.epica %}
                        <div class="task-meta">
                            <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica" style="text-decoration:none;">
                                {{ tarea.epica.titulo }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="task-meta">
                        <span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span>
                    </div>
                    <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
                    <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
                    <div class="task-actions">
                        <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
                        {% if tiene_permisos_admin %}
                            <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
                            <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted text-center">Sin tareas</p>
            {% endfor %}
        </div>

        <!-- Columna: APROBADO -->
        <div class="kanban-column column-aprobado" data-estado="APROBADO">
            <h5>âœ… Aprobado</h5>
            {% for tarea in aprobado %}
                <div class="task-card" draggable="true" data-id="{{ tarea.id }}">
                    <div class="task-title">{{ tarea.titulo }}</div>

                    {% if tarea.epica %}
                        <div class="task-meta">
                            <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica" style="text-decoration:none;">
                                {{ tarea.epica.titulo }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="task-meta">
                        <span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span>
                    </div>
                    <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
                    <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
                    <div class="task-actions">
                        <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
                        {% if tiene_permisos_admin %}
                            <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
                            <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted text-center">Sin tareas</p>
            {% endfor %}
        </div>

        <!-- Columna: EN PROGRESO -->
        <div class="kanban-column column-en-progreso" data-estado="EN_PROGRESO">
            <h5>âš™ï¸ En Progreso</h5>
            {% for tarea in en_progreso %}
                <div class="task-card" draggable="true" data-id="{{ tarea.id }}">
                    <div class="task-title">{{ tarea.titulo }}</div>

                    {% if tarea.epica %}
                        <div class="task-meta">
                            <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica" style="text-decoration:none;">
                                {{ tarea.epica.titulo }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="task-meta">
                        <span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span>
                    </div>
                    <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
                    <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
                    <div class="task-actions">
                        <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
                        {% if tiene_permisos_admin %}
                            <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
                            <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted text-center">Sin tareas</p>
            {% endfor %}
        </div>

        <!-- Columna: COMPLETADO -->
        <div class="kanban-column column-completado" data-estado="COMPLETADO">
            <h5>ğŸ‰ Completado</h5>
            {% for tarea in completado %}
                <div class="task-card" draggable="true" data-id="{{ tarea.id }}">
                    <div class="task-title">{{ tarea.titulo }}</div>

                    {% if tarea.epica %}
                        <div class="task-meta">
                            <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica" style="text-decoration:none;">
                                {{ tarea.epica.titulo }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="task-meta">
                        <span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span>
                    </div>
                    <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
                    <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
                    <div class="task-actions">
                        <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
                        {% if tiene_permisos_admin %}
                            <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
                            <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted text-center">Sin tareas</p>
            {% endfor %}
        </div>

        <!-- Columna: BLOQUEADO -->
        <div class="kanban-column column-bloqueado" data-estado="BLOQUEADO">
            <h5>ğŸš« Bloqueado</h5>
            {% for tarea in bloqueado %}
                <div class="task-card" draggable="true" data-id="{{ tarea.id }}">
                    <div class="task-title">{{ tarea.titulo }}</div>

                    {% if tarea.epica %}
                        <div class="task-meta">
                            <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge-epica" style="text-decoration:none;">
                                {{ tarea.epica.titulo }}
                            </a>
                        </div>
                    {% endif %}

                    <div class="task-meta">
                        <span class="badge-{{ tarea.categoria|lower }}">{{ tarea.get_categoria_display }}</span>
                    </div>
                    <div class="task-meta">ğŸ‘¤ {% if tarea.asignado_a %}{{ tarea.asignado_a.user.first_name }}{% else %}â€”{% endif %}</div>
                    <div class="task-meta">ğŸ—“ {{ tarea.sprint }}</div>
                    <div class="task-actions">
                        <a href="{% url 'detalle_tarea' tarea.id %}" class="btn btn-info btn-sm">ğŸ‘ï¸ Ver</a>
                        {% if tiene_permisos_admin %}
                            <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-secondary btn-sm">âœï¸</a>
                            <a href="{% url 'eliminar_tarea' tarea.id %}" class="btn btn-delete btn-sm">ğŸ—‘ï¸</a>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-muted text-center">Sin tareas</p>
            {% endfor %}
        </div>
    </div>

    <script>
        let draggedCard = null;

        // Drag & Drop
        document.querySelectorAll(".task-card").forEach(card => {
            card.addEventListener("dragstart", e => {
                if (e.target.tagName === 'A') { e.preventDefault(); return; }
                draggedCard = card;
                card.classList.add("dragging");
            });
            card.addEventListener("dragend", () => { card.classList.remove("dragging"); });
        });

        document.querySelectorAll(".kanban-column").forEach(column => {
            column.addEventListener("dragover", e => { e.preventDefault(); column.classList.add("drag-over"); });
            column.addEventListener("dragleave", () => { column.classList.remove("drag-over"); });
            column.addEventListener("drop", e => {
                e.preventDefault();
                column.classList.remove("drag-over");
                if (draggedCard) {
                    column.appendChild(draggedCard);
                    const tareaId = draggedCard.dataset.id;
                    const nuevoEstado = column.dataset.estado;
                    fetch(`/tarea/${tareaId}/cambiar-estado/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ estado: nuevoEstado })
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.success) { alert('Error: ' + data.error); location.reload(); }
                    })
                    .catch(() => { alert('Error al actualizar el estado. Recarga la pÃ¡gina.'); location.reload(); });
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
