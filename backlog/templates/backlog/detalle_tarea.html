{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Detalle Tarea - NEUSI Task Manager</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f1f3f6; padding:20px; }
    .btn { padding:8px 16px; margin:5px; border:none; border-radius:5px;
           text-decoration:none; color:white; font-weight:bold; display:inline-block; }
    .btn-primary { background:#007bff; }
    .btn-secondary { background:#6c757d; }
    .btn-danger { background:#dc3545; }
    .btn-success { background:#28a745; }
    .btn-warning { background:#ffc107; color:#000; }
    .card { border:1px solid #ddd; padding:20px; margin:15px 0; border-radius:8px; background:#fff; }
    .badge { padding:4px 8px; border-radius:4px; color:white; font-size:0.9em; }
    .badge-ui { background:#dc3545; } .badge-nui { background:#28a745; }
    .badge-uni { background:#ffc107; color:#000; } .badge-nuni { background:#6c757d; }
    .badge-epica { background:#0d6efd; }
    .evidencia { border-left:3px solid #007bff; padding:10px 15px; margin:10px 0; background:#f8f9fa; border-radius:5px; }
  </style>
</head>
<body>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1>📋 Detalle de Tarea</h1>
    {% if request.user.is_authenticated %}
    <div style="text-align:right;">
      <a href="{% url 'home' %}" class="btn btn-secondary">🏠 Home</a>
      <span style="margin:0 15px;">👤 {{ request.user.first_name|default:request.user.username }}</span>
      <a href="{% url 'logout' %}" class="btn btn-danger">🚪 Cerrar Sesión</a>
    </div>
    {% endif %}
  </div>

  {% for message in messages %}
    <div class="card" style="background:#d4edda; border:1px solid #c3e6cb;">{{ message }}</div>
  {% endfor %}

  <div class="card">
    <h2>{{ tarea.titulo }}</h2>

    {% if tarea.epica %}
      <p><strong>Épica:</strong>
        <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge badge-epica">{{ tarea.epica.titulo }}</a>
      </p>
    {% endif %}

    <p><strong>Categoría:</strong>
      <span class="badge {% if tarea.categoria == 'UI' %}badge-ui{% elif tarea.categoria == 'NUI' %}badge-nui{% elif tarea.categoria == 'UNI' %}badge-uni{% else %}badge-nuni{% endif %}">
        {{ tarea.get_categoria_display }}
      </span>
    </p>

    <p><strong>Sprint:</strong> {{ tarea.sprint.inicio }} – {{ tarea.sprint.fin }}</p>

    <!-- 🔹 Lista de responsables -->
    <p><strong>Responsables:</strong>
      {% if tarea.asignados.all %}
        {% for r in tarea.asignados.all %}
          {{ r.user.first_name }} {{ r.user.last_name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% elif tarea.asignado_a %}
        {{ tarea.asignado_a.user.first_name }} {{ tarea.asignado_a.user.last_name }}
      {% else %}
        <span class="text-muted">—</span>
      {% endif %}
    </p>

    <p><strong>Estado workflow:</strong> {{ tarea.get_estado_display }}</p>
    <p><strong>Completada:</strong> {% if tarea.completada %}✅ Sí{% else %}⏳ No{% endif %}</p>

    {% if tarea.descripcion %}
      <h4>📝 Descripción</h4>
      <p style="background:#f8f9fa; padding:10px; border-radius:5px;">{{ tarea.descripcion|linebreaks }}</p>
    {% endif %}

    {% if tarea.criterios_aceptacion %}
      <h4>✅ Criterios de Aceptación</h4>
      <p style="background:#f8f9fa; padding:10px; border-radius:5px;">{{ tarea.criterios_aceptacion|linebreaks }}</p>
    {% endif %}

    {% if tarea.informe_cierre %}
      <h4>📄 Informe de Cierre</h4>
      <a href="{{ tarea.informe_cierre.url }}" target="_blank" class="btn btn-primary">📥 Descargar Informe</a>
    {% endif %}

    <!-- Botones -->
    <div style="margin-top:20px;">
      {% if puede_editar %}
        <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-success">✏️ Editar Tarea</a>
      {% endif %}
      {% if not tarea.completada and puede_cerrar %}
        <a href="{% url 'cerrar_tarea' tarea.id %}" class="btn btn-danger">✅ Cerrar Tarea</a>
      {% endif %}
      <a href="{% url 'backlog_lista' %}" class="btn btn-secondary">📋 Volver al Backlog</a>
    </div>
  </div>

  <!-- Evidencias -->
  <div class="card">
    <h3>📎 Evidencias</h3>

    {% if not tarea.completada and request.user.integrante.puede_agregar_evidencias %}
      <form method="post" action="{% url 'agregar_evidencia' tarea.id %}" enctype="multipart/form-data"
            style="background:#e9ecef; padding:15px; border-radius:5px; margin-bottom:20px;">
        {% csrf_token %}
        <div>{{ form.comentario.label_tag }} {{ form.comentario }}</div>
        <div>{{ form.archivo.label_tag }} {{ form.archivo }}</div>
        <button type="submit" class="btn btn-success mt-2">📎 Agregar Evidencia</button>
      </form>
    {% endif %}

    {% for evidencia in evidencias %}
      <div class="evidencia">
        <p><strong>👤 {{ evidencia.creado_por.first_name|default:evidencia.creado_por.username }}</strong> ·
           📅 {{ evidencia.creado_en|date:"d/m/Y H:i" }}</p>
        {% if evidencia.comentario %}<p>{{ evidencia.comentario|linebreaks }}</p>{% endif %}
        {% if evidencia.archivo %}
          <p><a href="{{ evidencia.archivo.url }}" target="_blank" class="btn btn-primary">📥 Descargar Archivo</a></p>
        {% endif %}
      </div>
    {% empty %}
      <p style="color:#666;font-style:italic;">No hay evidencias registradas.</p>
    {% endfor %}
  </div>

</body>
</html>
