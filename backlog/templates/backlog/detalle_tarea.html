{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Detalle Tarea - NEUSI Task Manager</title>
  <!-- Unificación: se usa la hoja de estilos externa de Juan -->
  <link rel="stylesheet" href="{% static 'backlog/tarea_detail.css' %}?v=1">
</head>
<body>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1>📋 Detalle de Tarea</h1>
    {% if request.user.is_authenticated %}
    <div style="text-align:right;">
      <a href="{% url 'home' %}" class="btn btn-secondary">🏠 Home</a>
      <span style="margin:0 15px;">👤 {{ request.user.first_name|default:request.user.username }}</span>
      <a href="{% url 'logout' %}" class="btn btn-danger">🚪 Cerrar Sesión</a>
    </div>
    {% endif %}
  </div>

  {% for message in messages %}
    <div class="card card-msg">{{ message }}</div>
  {% endfor %}

  <div class="card">
    <h2>{{ tarea.titulo }}</h2>

    {% if tarea.epica %}
      <p><strong>Épica:</strong>
        <a href="{% url 'epica_detail' tarea.epica.id %}" class="badge badge-epica">{{ tarea.epica.titulo }}</a>
      </p>
    {% endif %}

    <p><strong>Categoría:</strong>
      <span class="badge
        {% if tarea.categoria == 'UI' %}badge-ui
        {% elif tarea.categoria == 'NUI' %}badge-nui
        {% elif tarea.categoria == 'UNI' %}badge-uni
        {% else %}badge-nuni{% endif %}">
        {{ tarea.get_categoria_display }}
      </span>
    </p>

    <p><strong>Sprint:</strong>
      {% if tarea.sprint %}
        {{ tarea.sprint.inicio|date:"M d, Y" }} – {{ tarea.sprint.fin|date:"M d, Y" }}
      {% else %}
        <span class="muted">—</span>
      {% endif %}
    </p>

    <p><strong>Responsables:</strong>
      {% if tarea.asignados.all %}
        {% for r in tarea.asignados.all %}
          {{ r.user.first_name }} {{ r.user.last_name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      {% elif tarea.asignado_a %}
        {{ tarea.asignado_a.user.first_name }} {{ tarea.asignado_a.user.last_name }}
      {% else %}
        <span class="muted">—</span>
      {% endif %}
    </p>

    <p><strong>Estado workflow:</strong> {{ tarea.get_estado_display }}</p>
    <p><strong>Completada:</strong> {% if tarea.completada %}✅ Sí{% else %}⏳ No{% endif %}</p>

    {% if tarea.descripcion %}
      <h4>📝 Descripción</h4>
      <p class="soft-block">{{ tarea.descripcion|linebreaks }}</p>
    {% endif %}

    {% if tarea.criterios_aceptacion %}
      <h4>✅ Criterios de Aceptación</h4>
      <p class="soft-block">{{ tarea.criterios_aceptacion|linebreaks }}</p>
    {% endif %}

    {% if tarea.informe_cierre %}
      <h4>📄 Informe de Cierre</h4>
      <a href="{{ tarea.informe_cierre.url }}" target="_blank" class="btn btn-primary">📥 Descargar Informe</a>
    {% endif %}

    <div class="actions">
      {% if puede_editar %}
        <a href="{% url 'editar_tarea' tarea.id %}" class="btn btn-success">✏️ Editar Tarea</a>
      {% endif %}
      {% if not tarea.completada and puede_cerrar %}
        <a href="{% url 'cerrar_tarea' tarea.id %}" class="btn btn-danger">✅ Cerrar Tarea</a>
      {% endif %}
      <a href="{% url 'backlog_lista' %}" class="btn btn-secondary">📋 Volver al Backlog</a>
    </div>
  </div>

  <!-- =======================
       📎 Evidencias
       ======================= -->
  <div class="card">
    <h3>📎 Evidencias</h3>

    {% if not tarea.completada %}
      {% if tiene_permisos_admin or puede_editar or request.user.integrante.puede_agregar_evidencias %}
        <form method="post" action="{% url 'agregar_evidencia' tarea.id %}" enctype="multipart/form-data" class="evidencia-form">
          {% csrf_token %}
          <div>{{ form.comentario.label_tag }} {{ form.comentario }}</div>
          <div>{{ form.archivo.label_tag }} {{ form.archivo }}</div>
          <button type="submit" class="btn btn-success mt-2">📎 Agregar Evidencia</button>
        </form>
      {% else %}
        <p class="muted" style="margin-bottom:10px;">
          No tienes permisos para agregar evidencias en esta tarea.
        </p>
      {% endif %}
    {% else %}
      <p class="muted" style="margin-bottom:10px;">
        La tarea está completada; no se pueden agregar nuevas evidencias.
      </p>
    {% endif %}

    {% for evidencia in evidencias %}
      <div class="evidencia">
        <header>
          <p><strong>👤 {{ evidencia.creado_por.first_name|default:evidencia.creado_por.username }}</strong> ·
             📅 {{ evidencia.creado_en|date:"d/m/Y H:i" }}</p>

          {% if tiene_permisos_admin or evidencia.creado_por_id == request.user.id or puede_editar or request.user.integrante.puede_agregar_evidencias %}
            <div>
              <a href="{% url 'editar_evidencia' tarea.id evidencia.id %}" class="btn btn-light">✏️ Editar</a>
              <form method="post" action="{% url 'eliminar_evidencia' tarea.id evidencia.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">🗑️ Eliminar</button>
              </form>
            </div>
          {% endif %}
        </header>

        {% if evidencia.comentario %}
          <p style="margin-top:8px;">{{ evidencia.comentario|linebreaks }}</p>
        {% endif %}
        {% if evidencia.archivo %}
          <p><a href="{{ evidencia.archivo.url }}" target="_blank" class="btn btn-primary">📥 Descargar Archivo</a></p>
        {% endif %}
      </div>
    {% empty %}
      <p class="muted" style="font-style:italic;">No hay evidencias registradas.</p>
    {% endfor %}
  </div>

</body>
</html>

