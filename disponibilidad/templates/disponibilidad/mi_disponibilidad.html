{% extends "base.html" %}
{% load static disponibilidad_extras %}
{% block title %}Mi Disponibilidad (Semana){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'disponibilidad/disponibilidad.css' %}?v=18">
{% endblock %}


{% block content %}
<div class="container py-4">

  <!-- Barra con regresar y ver equipo -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex gap-2">
      <a class="btn btn-light border" href="{{ home_url }}">‚Ü© Volver</a>
      {% if puede_ver_equipo %}
        <a class="btn btn-outline-primary" href="{{ equipo_url }}">üë• Ver equipo</a>
      {% endif %}
    </div>
    <div class="btn-group">
      <a class="btn btn-outline-secondary" href="?semana={{ prev_w|date:'Y-m-d' }}">‚Üê Semana anterior</a>
      <span class="btn btn-light disabled">
        {{ semana.semana_inicio|date:"d M" }} ‚Äî {{ semana.semana_fin|date:"d M Y" }}
      </span>
      <a class="btn btn-outline-secondary" href="?semana={{ next_w|date:'Y-m-d' }}">Semana siguiente ‚Üí</a>
    </div>
  </div>

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" class="card" id="form-semana">
    {% csrf_token %}

 <style>
      .week-grid { display:grid; grid-template-columns: repeat(7, minmax(140px,1fr)); gap:12px; }
      @media (max-width: 1200px){ .week-grid{ grid-template-columns: repeat(3,1fr);} }
      @media (max-width: 768px){ .week-grid{ grid-template-columns: repeat(2,1fr);} }
      @media (max-width: 576px){ .week-grid{ grid-template-columns: 1fr;} }

      .mini-week { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
      .mini-day { border:1px solid #0b50db; border-radius:10px; padding:8px; min-height:72px; display:flex; flex-direction:column; gap:6px;}
      .mini-day h6{ font-size:12px; margin:0; color:#05295b; display:flex; justify-content:space-between; }
      .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
      .pill-green{ background:#dcfce7; color:#166534; }
      .pill-gray{ background:#e5e7eb; color:#334155; }
      .pill-blue{ background:#dbeafe; color:#1e3a8a; }

      .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
      .chip { border:1px solid #d1dbd5; background:#f8fafc; padding:4px 8px; border-radius:999px; font-size:12px; cursor:pointer; }
      .chip:hover { background:#eef2ffe7; border-color:#c7d2fe; }

      .time-input { font-variant-numeric: tabular-nums; }
      .is-invalid { border-color:#dc3545 !important; }
      .invalid-hint { color:#dc3545; font-size:12px; display:none; }
      .invalid-hint.show { display:block; }
    </style>

    <!-- datalist global para sugerencias -->
    <datalist id="horas_sugeridas">
      {% for h in "00,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23"|cut:"," %}
        <option value="{{ h }}:00"></option>
        <option value="{{ h }}:15"></option>
        <option value="{{ h }}:30"></option>
        <option value="{{ h }}:45"></option>
      {% endfor %}
    </datalist>

    <div class="card-body">
      <!-- 7 columnas de edici√≥n -->
      <div class="week-grid">
        {% for d in semana.dias.all %}
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>
                {{ d.get_dia_semana_display }}
                <small class="text-muted">({{ semana.semana_inicio|add_days:d.dia_semana|date:"Y-m-d" }})</small>
              </strong>
              <span class="badge {% if d.tipo == 'D' %}text-bg-success{% elif d.tipo == 'N' %}text-bg-secondary{% else %}text-bg-info{% endif %}" id="badge_{{ d.dia_semana }}">
                <span id="badge_txt_{{ d.dia_semana }}">
                  {% if d.tipo == "D" %}Disponible{% elif d.tipo == "N" %}No{% else %}
                    {% if d.hora_inicio and d.hora_fin %}
                      {{ d.hora_inicio|time:"H:i" }}‚Äì{{ d.hora_fin|time:"H:i" }}
                    {% else %}Rango{% endif %}
                  {% endif %}
                </span>
              </span>
            </div>

            <div class="mb-2">
              <label class="form-label">Estado</label>
              <select class="form-select estado-select" name="estado_{{ d.dia_semana }}" data-dia="{{ d.dia_semana }}">
                <option value="D" {% if d.tipo == "D" %}selected{% endif %}>Disponible todo el d√≠a</option>
                <option value="N" {% if d.tipo == "N" %}selected{% endif %}>No disponible</option>
                <option value="R" {% if d.tipo == "R" %}selected{% endif %}>Rango (horas)</option>
              </select>
            </div>

            <!-- Campos de tiempo TEXT con autocompletar -->
            <div class="rango-wrap" id="rango_{{ d.dia_semana }}" {% if d.tipo != "R" %}style="display:none"{% endif %}>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Inicio</label>
                  <input
                    type="text"
                    class="form-control time-input"
                    name="ini_{{ d.dia_semana }}"
                    id="ini_{{ d.dia_semana }}"
                    value="{{ d.hora_inicio|time:'H:i'|default_if_none:'' }}"
                    placeholder="hh:mm"
                    list="horas_sugeridas"
                    inputmode="numeric"
                    autocomplete="off">
                  <div class="invalid-hint" id="hint_ini_{{ d.dia_semana }}">Formato v√°lido: 07:00</div>
                </div>
                <div class="col-6">
                  <label class="form-label">Fin</label>
                  <input
                    type="text"
                    class="form-control time-input"
                    name="fin_{{ d.dia_semana }}"
                    id="fin_{{ d.dia_semana }}"
                    value="{{ d.hora_fin|time:'H:i'|default_if_none:'' }}"
                    placeholder="hh:mm"
                    list="horas_sugeridas"
                    inputmode="numeric"
                    autocomplete="off">
                  <div class="invalid-hint" id="hint_fin_{{ d.dia_semana }}">Formato v√°lido: 16:30</div>
                </div>
              </div>

              <!-- Atajos r√°pidos -->
              <div class="chips" data-dia="{{ d.dia_semana }}">
                <span class="chip" data-range="07:00-16:00">07‚Äì16</span>
                <span class="chip" data-range="08:00-17:00">08‚Äì17</span>
                <span class="chip" data-range="09:00-18:00">09‚Äì18</span>
                <span class="chip" data-range="19:00-22:00">19‚Äì22</span>
                <span class="chip" data-clear="1">Limpiar</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <a class="btn btn-outline-secondary" href="?semana={{ semana.semana_inicio|date:'Y-m-d' }}">Deshacer</a>
      <button class="btn btn-primary">üíæ Guardar semana</button>
    </div>
  </form>

  <!-- Mini-calendario semanal visual -->
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>üìÖ Resumen visual de la semana</span>
      <div class="d-flex gap-2">
        <span class="pill pill-green">Disponible</span>
        <span class="pill pill-gray">No disponible</span>
        <span class="pill pill-blue">Rango</span>
      </div>
    </div>
    <div class="card-body">
      <div class="mini-week">
        {% for d in semana.dias.all %}
          <div class="mini-day">
            <h6>
              <span>{{ d.get_dia_semana_display|slice:":3" }}</span>
              <span>{{ semana.semana_inicio|add_days:d.dia_semana|date:"d/M" }}</span>
            </h6>
            {% if d.tipo == "D" %}
              <span class="pill pill-green">Disponible</span>
            {% elif d.tipo == "N" %}
              <span class="pill pill-gray">No disponible</span>
            {% else %}
              {% if d.hora_inicio and d.hora_fin %}
                <span class="pill pill-blue">{{ d.hora_inicio|time:"H:i" }}‚Äì{{ d.hora_fin|time:"H:i" }}</span>
              {% else %}
                <span class="pill pill-blue">Rango</span>
              {% endif %}
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>

<script>
function setBadge(dia, estado, iniVal, finVal) {
  const badge = document.getElementById('badge_' + dia);
  const txt = document.getElementById('badge_txt_' + dia);
  if (!badge || !txt) return;
  badge.classList.remove('text-bg-success', 'text-bg-secondary', 'text-bg-info');

  if (estado === 'D') { badge.classList.add('text-bg-success'); txt.textContent = 'Disponible'; }
  else if (estado === 'N') { badge.classList.add('text-bg-secondary'); txt.textContent = 'No'; }
  else { badge.classList.add('text-bg-info'); txt.textContent = (iniVal && finVal) ? (iniVal + '‚Äì' + finVal) : 'Rango'; }
}

// Normaliza entradas: "7", "730", "7:3", "07:3" -> "07:30" / "07:03"
function normalizeTime(v) {
  if (!v) return "";
  v = v.trim();
  // si viene con colon
  if (v.includes(":")) {
    const [h, m] = v.split(":");
    const hh = Math.min(23, Math.max(0, parseInt(h || "0", 10)));
    const mm = Math.min(59, Math.max(0, parseInt(m || "0", 10)));
    return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
  }
  // sin colon (p.ej. 7, 730, 0730)
  if (/^\d{1,4}$/.test(v)) {
    if (v.length <= 2) {
      const hh = Math.min(23, Math.max(0, parseInt(v, 10)));
      return String(hh).padStart(2, "0") + ":00";
    } else {
      const hh = Math.min(23, Math.max(0, parseInt(v.slice(0, -2), 10)));
      const mm = Math.min(59, Math.max(0, parseInt(v.slice(-2), 10)));
      return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
    }
  }
  return v; // deja pasar para que el validador marque error
}

function isValidHHMM(v) {
  return /^([01]\d|2[0-3]):([0-5]\d)$/.test(v);
}

document.querySelectorAll('.estado-select').forEach(sel => {
  const dia = sel.dataset.dia;
  const wrap = document.getElementById('rango_' + dia);
  const ini = document.getElementById('ini_' + dia);
  const fin = document.getElementById('fin_' + dia);
  const hintIni = document.getElementById('hint_ini_' + dia);
  const hintFin = document.getElementById('hint_fin_' + dia);

  const updateBadge = () => setBadge(dia, sel.value, ini ? ini.value : '', fin ? fin.value : '');

  // init
  updateBadge();

  sel.addEventListener('change', () => {
    if (sel.value === 'R') wrap.style.display = '';
    else {
      wrap.style.display = 'none';
      if (ini) ini.value = '';
      if (fin) fin.value = '';
      if (ini) ini.classList.remove('is-invalid');
      if (fin) fin.classList.remove('is-invalid');
      if (hintIni) hintIni.classList.remove('show');
      if (hintFin) hintFin.classList.remove('show');
    }
    updateBadge();
  });

  [ini, fin].forEach(inp => {
    if (!inp) return;
    inp.addEventListener('input', () => {
      // no forzamos formato mientras escribe; solo actualizamos badge
      updateBadge();
    });
    inp.addEventListener('blur', () => {
      inp.value = normalizeTime(inp.value);
      const ok = !inp.value || isValidHHMM(inp.value);
      inp.classList.toggle('is-invalid', !ok);
      const hint = (inp === ini) ? hintIni : hintFin;
      if (hint) hint.classList.toggle('show', !ok);
      updateBadge();
    });
    inp.addEventListener('change', () => {
      inp.value = normalizeTime(inp.value);
      updateBadge();
    });
  });

  // Atajos (chips)
  const chipsWrap = wrap.querySelector('.chips');
  if (chipsWrap) {
    chipsWrap.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        if (chip.dataset.clear) {
          if (ini) ini.value = '';
          if (fin) fin.value = '';
        } else if (chip.dataset.range) {
          const [a,b] = chip.dataset.range.split('-');
          if (ini) ini.value = a;
          if (fin) fin.value = b;
        }
        if (sel.value !== 'R') {
          sel.value = 'R';
          wrap.style.display = '';
        }
        if (ini) { ini.classList.remove('is-invalid'); if (hintIni) hintIni.classList.remove('show'); }
        if (fin) { fin.classList.remove('is-invalid'); if (hintFin) hintFin.classList.remove('show'); }
        updateBadge();
      });
    });
  }
});

// Validaci√≥n al enviar: si hay d√≠as en "Rango", exigir hh:mm v√°lidos y ini < fin
document.getElementById('form-semana').addEventListener('submit', function (e) {
  let firstError = null;
  document.querySelectorAll('.estado-select').forEach(sel => {
    const dia = sel.dataset.dia;
    if (sel.value !== 'R') return;
    const ini = document.getElementById('ini_' + dia);
    const fin = document.getElementById('fin_' + dia);
    const hintIni = document.getElementById('hint_ini_' + dia);
    const hintFin = document.getElementById('hint_fin_' + dia);

    if (ini) ini.value = normalizeTime(ini.value);
    if (fin) fin.value = normalizeTime(fin.value);

    const okIni = ini && isValidHHMM(ini.value);
    const okFin = fin && isValidHHMM(fin.value);

    if (!okIni) { ini.classList.add('is-invalid'); if (hintIni) hintIni.classList.add('show'); firstError = firstError || ini; }
    if (!okFin) { fin.classList.add('is-invalid'); if (hintFin) hintFin.classList.add('show'); firstError = firstError || fin; }

    if (okIni && okFin) {
      // compara tiempos
      const [hi, mi] = ini.value.split(':').map(Number);
      const [hf, mf] = fin.value.split(':').map(Number);
      const si = hi*60 + mi, sf = hf*60 + mf;
      if (si >= sf) {
        fin.classList.add('is-invalid');
        if (hintFin) { hintFin.textContent = 'Fin debe ser mayor que inicio'; hintFin.classList.add('show'); }
        firstError = firstError || fin;
      } else {
        fin.classList.remove('is-invalid');
        if (hintFin) { hintFin.textContent = 'Formato v√°lido: 16:30'; hintFin.classList.remove('show'); }
      }
    }
  });

  if (firstError) {
    e.preventDefault();
    firstError.scrollIntoView({behavior:'smooth', block:'center'});
    firstError.focus();
  }
});
</script>
{% endblock %}
