{% extends "base.html" %}
{% load static disponibilidad_extras %}
{% block title %}Mi Disponibilidad (Semana){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'disponibilidad/disponibilidad.css' %}?v=21">
{% endblock %}

{% block content %}
<div class="dispon-page">
  <div class="container py-4">

    <!-- Encabezado -->
    <div class="dispon-header card border-0 shadow-sm-soft mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <div class="dispon-icon-wrap">
              <i class="bi bi-calendar-week"></i>
            </div>
            <div>
              <h1 class="h4 mb-1">Mi disponibilidad semanal</h1>
              <p class="text-muted small mb-0">
                Marca para cada día si estás disponible todo el día, no disponible o en un rango horario específico.
              </p>
            </div>
          </div>
          <div class="btn-group semana-nav">
            <a class="btn btn-outline-secondary"
               href="?semana={{ prev_w|date:'Y-m-d' }}">← Semana anterior</a>
            <span class="btn btn-light disabled">
              {{ semana.semana_inicio|date:"d M" }} — {{ semana.semana_fin|date:"d M Y" }}
            </span>
            <a class="btn btn-outline-secondary"
               href="?semana={{ next_w|date:'Y-m-d' }}">Semana siguiente →</a>
          </div>
        </div>

        <!-- Leyenda & ayuda -->
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
          <div class="d-flex flex-wrap gap-2">
            <span class="neusi-chip">
              <i class="bi bi-check-circle-fill chip-icon disp"></i>
              Disponible todo el día
            </span>
            <span class="neusi-chip">
              <i class="bi bi-slash-circle-fill chip-icon no"></i>
              No disponible
            </span>
            <span class="neusi-chip">
              <i class="bi bi-clock-fill chip-icon rango"></i>
              Rango de horas
            </span>
          </div>
          <div class="text-muted small fw-medium">
            Consejo: usa los chips de horas rápidas (07–16, 08–17, etc.) para rellenar más rápido.
          </div>
        </div>

        <!-- Navegación secundaria -->
        <div class="d-flex align-items-center justify-content-between mt-3 flex-wrap gap-2">
          <div class="d-flex gap-2">
            <a class="btn btn-light border" href="{{ home_url }}">
              <i class="bi bi-arrow-left-short me-1"></i> Volver
            </a>
            {% if puede_ver_equipo %}
              <a class="btn btn-outline-primary" href="{{ equipo_url }}">
                <i class="bi bi-people-fill me-1"></i> Ver equipo
              </a>
            {% endif %}
          </div>
          <div class="text-muted small">
            Hoy es <strong>{{ hoy|date:"l d M Y" }}</strong>
          </div>
        </div>
      </div>
    </div>

    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} shadow-sm-soft">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" class="card border-0 shadow-main mb-4" id="form-semana">
      {% csrf_token %}

      <!-- datalist global para sugerencias -->
      <datalist id="horas_sugeridas">
        {% for h in "00,01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23"|cut:"," %}
          <option value="{{ h }}:00"></option>
          <option value="{{ h }}:15"></option>
          <option value="{{ h }}:30"></option>
          <option value="{{ h }}:45"></option>
        {% endfor %}
      </datalist>

      <div class="card-body">
        <!-- 7 columnas de edición -->
        <div class="week-grid">
          {% for d in semana.dias.all %}
            <div class="day-card">
              <div class="day-card-inner">

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <h6 class="mb-0">
                      {{ d.get_dia_semana_display }}
                    </h6>
                    <small class="text-muted">
                      {{ semana.semana_inicio|add_days:d.dia_semana|date:"Y-m-d" }}
                    </small>
                  </div>
                  <span class="badge estado-badge
                               {% if d.tipo == 'D' %}badge-disp
                               {% elif d.tipo == 'N' %}badge-no
                               {% else %}badge-rango{% endif %}"
                        id="badge_{{ d.dia_semana }}">
                    <span id="badge_txt_{{ d.dia_semana }}">
                      {% if d.tipo == "D" %}Disponible{% elif d.tipo == "N" %}No{% else %}
                        {% if d.hora_inicio and d.hora_fin %}
                          {{ d.hora_inicio|time:"H:i" }}–{{ d.hora_fin|time:"H:i" }}
                        {% else %}Rango{% endif %}
                      {% endif %}
                    </span>
                  </span>
                </div>

                <div class="mb-3">
                  <label class="form-label mb-1">Estado del día</label>
                  <select class="form-select estado-select"
                          name="estado_{{ d.dia_semana }}"
                          data-dia="{{ d.dia_semana }}">
                    <option value="D" {% if d.tipo == "D" %}selected{% endif %}>Disponible todo el día</option>
                    <option value="N" {% if d.tipo == "N" %}selected{% endif %}>No disponible</option>
                    <option value="R" {% if d.tipo == "R" %}selected{% endif %}>Rango (horas)</option>
                  </select>
                </div>

                <!-- Campos de tiempo TEXT con autocompletar -->
                <div class="rango-wrap" id="rango_{{ d.dia_semana }}"
                     {% if d.tipo != "R" %}style="display:none"{% endif %}>
                  <div class="row g-2">
                    <div class="col-6">
                      <label class="form-label">Inicio</label>
                      <input
                        type="text"
                        class="form-control time-input"
                        name="ini_{{ d.dia_semana }}"
                        id="ini_{{ d.dia_semana }}"
                        value="{{ d.hora_inicio|time:'H:i'|default_if_none:'' }}"
                        placeholder="hh:mm"
                        list="horas_sugeridas"
                        inputmode="numeric"
                        autocomplete="off">
                      <div class="invalid-hint" id="hint_ini_{{ d.dia_semana }}">Formato válido: 07:00</div>
                    </div>
                    <div class="col-6">
                      <label class="form-label">Fin</label>
                      <input
                        type="text"
                        class="form-control time-input"
                        name="fin_{{ d.dia_semana }}"
                        id="fin_{{ d.dia_semana }}"
                        value="{{ d.hora_fin|time:'H:i'|default_if_none:'' }}"
                        placeholder="hh:mm"
                        list="horas_sugeridas"
                        inputmode="numeric"
                        autocomplete="off">
                      <div class="invalid-hint" id="hint_fin_{{ d.dia_semana }}">Formato válido: 16:30</div>
                    </div>
                  </div>

                  <!-- Atajos rápidos -->
                  <div class="chips mt-2" data-dia="{{ d.dia_semana }}">
                    <span class="chip" data-range="07:00-16:00">07–16</span>
                    <span class="chip" data-range="08:00-17:00">08–17</span>
                    <span class="chip" data-range="09:00-18:00">09–18</span>
                    <span class="chip" data-range="19:00-22:00">19–22</span>
                    <span class="chip chip-clear" data-clear="1">
                      <i class="bi bi-eraser-fill me-1"></i>Limpiar
                    </span>
                  </div>
                </div>

              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
        <button type="button"
                class="btn btn-outline-secondary"
                onclick="window.location='?semana={{ semana.semana_inicio|date:'Y-m-d' }}'">
          <i class="bi bi-arrow-counterclockwise me-1"></i>
          Deshacer cambios
        </button>
        <button class="btn btn-neusi-primary">
          <i class="bi bi-save2 me-1"></i>
          Guardar semana
        </button>
      </div>
    </form>

    <!-- Mini-calendario semanal visual -->
    <div class="card border-0 shadow-sm-soft">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">
          <i class="bi bi-eye me-1"></i>
          Resumen visual de la semana
        </span>
        <div class="d-flex gap-2 align-items-center">
          <span class="pill pill-green">Disponible</span>
          <span class="pill pill-gray">No disponible</span>
          <span class="pill pill-blue">Rango</span>
        </div>
      </div>
      <div class="card-body">
        <div class="mini-week">
          {% for d in semana.dias.all %}
            <div class="mini-day">
              <h6>
                <span>{{ d.get_dia_semana_display|slice:":3" }}</span>
                <span>{{ semana.semana_inicio|add_days:d.dia_semana|date:"d/M" }}</span>
              </h6>
              {% if d.tipo == "D" %}
                <span class="pill pill-green">Disponible</span>
              {% elif d.tipo == "N" %}
                <span class="pill pill-gray">No disponible</span>
              {% else %}
                {% if d.hora_inicio and d.hora_fin %}
                  <span class="pill pill-blue">{{ d.hora_inicio|time:"H:i" }}–{{ d.hora_fin|time:"H:i" }}</span>
                {% else %}
                  <span class="pill pill-blue">Rango</span>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>
</div>

<script>
function setBadge(dia, estado, iniVal, finVal) {
  const badge = document.getElementById('badge_' + dia);
  const txt = document.getElementById('badge_txt_' + dia);
  if (!badge || !txt) return;
  badge.classList.remove('badge-disp', 'badge-no', 'badge-rango');

  if (estado === 'D') { badge.classList.add('badge-disp'); txt.textContent = 'Disponible'; }
  else if (estado === 'N') { badge.classList.add('badge-no'); txt.textContent = 'No'; }
  else { badge.classList.add('badge-rango'); txt.textContent = (iniVal && finVal) ? (iniVal + '–' + finVal) : 'Rango'; }
}

// Normaliza entradas: "7", "730", "7:3", "07:3" -> "07:30" / "07:03"
function normalizeTime(v) {
  if (!v) return "";
  v = v.trim();
  // si viene con colon
  if (v.includes(":")) {
    const [h, m] = v.split(":");
    const hh = Math.min(23, Math.max(0, parseInt(h || "0", 10)));
    const mm = Math.min(59, Math.max(0, parseInt(m || "0", 10)));
    return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
  }
  // sin colon (p.ej. 7, 730, 0730)
  if (/^\d{1,4}$/.test(v)) {
    if (v.length <= 2) {
      const hh = Math.min(23, Math.max(0, parseInt(v, 10)));
      return String(hh).padStart(2, "0") + ":00";
    } else {
      const hh = Math.min(23, Math.max(0, parseInt(v.slice(0, -2), 10)));
      const mm = Math.min(59, Math.max(0, parseInt(v.slice(-2), 10)));
      return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
    }
  }
  return v; // deja pasar para que el validador marque error
}

function isValidHHMM(v) {
  return /^([01]\d|2[0-3]):([0-5]\d)$/.test(v);
}

document.querySelectorAll('.estado-select').forEach(sel => {
  const dia = sel.dataset.dia;
  const wrap = document.getElementById('rango_' + dia);
  const ini = document.getElementById('ini_' + dia);
  const fin = document.getElementById('fin_' + dia);
  const hintIni = document.getElementById('hint_ini_' + dia);
  const hintFin = document.getElementById('hint_fin_' + dia);

  const updateBadge = () => setBadge(dia, sel.value, ini ? ini.value : '', fin ? fin.value : '');

  // init
  updateBadge();

  sel.addEventListener('change', () => {
    if (sel.value === 'R') wrap.style.display = '';
    else {
      wrap.style.display = 'none';
      if (ini) ini.value = '';
      if (fin) fin.value = '';
      if (ini) ini.classList.remove('is-invalid');
      if (fin) fin.classList.remove('is-invalid');
      if (hintIni) hintIni.classList.remove('show');
      if (hintFin) hintFin.classList.remove('show');
    }
    updateBadge();
  });

  [ini, fin].forEach(inp => {
    if (!inp) return;
    inp.addEventListener('input', () => {
      updateBadge();
    });
    inp.addEventListener('blur', () => {
      inp.value = normalizeTime(inp.value);
      const ok = !inp.value || isValidHHMM(inp.value);
      inp.classList.toggle('is-invalid', !ok);
      const hint = (inp === ini) ? hintIni : hintFin;
      if (hint) hint.classList.toggle('show', !ok);
      updateBadge();
    });
    inp.addEventListener('change', () => {
      inp.value = normalizeTime(inp.value);
      updateBadge();
    });
  });

  // Atajos (chips)
  const chipsWrap = wrap.querySelector('.chips');
  if (chipsWrap) {
    chipsWrap.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        if (chip.dataset.clear) {
          if (ini) ini.value = '';
          if (fin) fin.value = '';
        } else if (chip.dataset.range) {
          const [a,b] = chip.dataset.range.split('-');
          if (ini) ini.value = a;
          if (fin) fin.value = b;
        }
        if (sel.value !== 'R') {
          sel.value = 'R';
          wrap.style.display = '';
        }
        if (ini) { ini.classList.remove('is-invalid'); if (hintIni) hintIni.classList.remove('show'); }
        if (fin) { fin.classList.remove('is-invalid'); if (hintFin) hintFin.classList.remove('show'); }
        updateBadge();
      });
    });
  }
});

// Validación al enviar
document.getElementById('form-semana').addEventListener('submit', function (e) {
  let firstError = null;
  document.querySelectorAll('.estado-select').forEach(sel => {
    const dia = sel.dataset.dia;
    if (sel.value !== 'R') return;
    const ini = document.getElementById('ini_' + dia);
    const fin = document.getElementById('fin_' + dia);
    const hintIni = document.getElementById('hint_ini_' + dia);
    const hintFin = document.getElementById('hint_fin_' + dia);

    if (ini) ini.value = normalizeTime(ini.value);
    if (fin) fin.value = normalizeTime(fin.value);

    const okIni = ini && isValidHHMM(ini.value);
    const okFin = fin && isValidHHMM(fin.value);

    if (!okIni) { ini.classList.add('is-invalid'); if (hintIni) hintIni.classList.add('show'); firstError = firstError || ini; }
    if (!okFin) { fin.classList.add('is-invalid'); if (hintFin) hintFin.classList.add('show'); firstError = firstError || fin; }

    if (okIni && okFin) {
      const [hi, mi] = ini.value.split(':').map(Number);
      const [hf, mf] = fin.value.split(':').map(Number);
      const si = hi*60 + mi, sf = hf*60 + mf;
      if (si >= sf) {
        fin.classList.add('is-invalid');
        if (hintFin) { hintFin.textContent = 'Fin debe ser mayor que inicio'; hintFin.classList.add('show'); }
        firstError = firstError || fin;
      } else {
        fin.classList.remove('is-invalid');
        if (hintFin) { hintFin.textContent = 'Formato válido: 16:30'; hintFin.classList.remove('show'); }
      }
    }
  });

  if (firstError) {
    e.preventDefault();
    firstError.scrollIntoView({behavior:'smooth', block:'center'});
    firstError.focus();
  }
});
</script>
{% endblock %}
